using RugbyApiApp.Data;
using RugbyApiApp.Services;

namespace RugbyApiApp
{
    internal class Program
    {
        static async Task Main(string[] args)
        {
            Console.WriteLine("=== Rugby API Console Application ===\n");

            // Initialize database
            using (var context = new RugbyDbContext())
            {
                context.Database.EnsureCreated();
                Console.WriteLine("✓ Database initialized\n");
            }

            // Get API key from environment variable
            string? apiKey = Environment.GetEnvironmentVariable("RUGBY_API_KEY");
            if (string.IsNullOrEmpty(apiKey))
            {
                Console.WriteLine("ERROR: RUGBY_API_KEY environment variable not set.");
                Console.WriteLine("Please set your api-sports.io API key as an environment variable.");
                return;
            }

            var apiClient = new RugbyApiClient(apiKey);
            var dataService = new DataService(new RugbyDbContext());

            try
            {
                // Fetch and store teams
                await FetchAndStoreTeamsAsync(apiClient, dataService);

                // Fetch and store matches for current season (2024)
                await FetchAndStoreMatchesAsync(apiClient, dataService, 2024);

                // Display stored data
                await DisplayStoredDataAsync(dataService);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ERROR: {ex.Message}");
                if (ex.InnerException != null)
                {
                    Console.WriteLine($"Details: {ex.InnerException.Message}");
                }
            }

            Console.WriteLine("\n=== Application finished ===");
        }

        static async Task FetchAndStoreTeamsAsync(RugbyApiClient apiClient, DataService dataService)
        {
            Console.WriteLine("Fetching teams from API...");
            try
            {
                var teams = await apiClient.GetTeamsAsync(page: 1);

                if (teams != null && teams.Count > 0)
                {
                    Console.WriteLine($"Retrieved {teams.Count} teams");

                    foreach (var teamResponse in teams)
                    {
                        if (teamResponse.Id.HasValue && teamResponse.Name != null)
                        {
                            var cdnLogo = RugbyApiClient.ConvertToCdnUrl(teamResponse.Logo);
                            var cdnFlag = RugbyApiClient.ConvertToCdnUrl(teamResponse.Flag);

                            await dataService.UpsertTeamAsync(
                                teamResponse.Id.Value,
                                teamResponse.Name,
                                teamResponse.Code,
                                cdnFlag,
                                cdnLogo
                            );
                        }
                    }

                    Console.WriteLine($"✓ Stored teams in database\n");
                }
                else
                {
                    Console.WriteLine("⚠ No teams retrieved from API\n");
                }
            }
            catch (HttpRequestException ex)
            {
                Console.WriteLine($"⚠ Error fetching teams (API may require authentication): {ex.Message}\n");
            }
        }

        static async Task FetchAndStoreMatchesAsync(RugbyApiClient apiClient, DataService dataService, int season)
        {
            Console.WriteLine($"Fetching matches for season {season}...");
            try
            {
                var matches = await apiClient.GetMatchesBySeasonAsync(season, page: 1);

                if (matches != null && matches.Count > 0)
                {
                    Console.WriteLine($"Retrieved {matches.Count} matches");

                    foreach (var matchResponse in matches)
                    {
                        if (matchResponse.Id.HasValue && 
                            matchResponse.Home?.Id.HasValue == true && 
                            matchResponse.Away?.Id.HasValue == true)
                        {
                            await dataService.UpsertMatchAsync(
                                matchResponse.Id.Value,
                                matchResponse.LeagueId,
                                matchResponse.Season,
                                matchResponse.Home.Id.Value,
                                matchResponse.Away.Id.Value,
                                matchResponse.Date,
                                matchResponse.Status,
                                matchResponse.Venue,
                                matchResponse.Score?.Home,
                                matchResponse.Score?.Away
                            );
                        }
                    }

                    Console.WriteLine($"✓ Stored matches in database\n");
                }
                else
                {
                    Console.WriteLine("⚠ No matches retrieved from API\n");
                }
            }
            catch (HttpRequestException ex)
            {
                Console.WriteLine($"⚠ Error fetching matches (API may require authentication): {ex.Message}\n");
            }
        }

        static async Task DisplayStoredDataAsync(DataService dataService)
        {
            Console.WriteLine("=== Stored Data ===\n");

            var teams = await dataService.GetTeamsAsync();
            Console.WriteLine($"Teams in database: {teams.Count}");
            foreach (var team in teams.Take(5))
            {
                Console.WriteLine($"  - {team.Name} ({team.Code})");
            }

            var matches = await dataService.GetMatchesAsync();
            Console.WriteLine($"\nMatches in database: {matches.Count}");
            foreach (var match in matches.Take(5))
            {
                var homeTeam = match.HomeTeam?.Name ?? "Unknown";
                var awayTeam = match.AwayTeam?.Name ?? "Unknown";
                Console.WriteLine($"  - {homeTeam} vs {awayTeam} ({match.Status})");
                if (match.HomeTeamScore.HasValue && match.AwayTeamScore.HasValue)
                {
                    Console.WriteLine($"    Score: {match.HomeTeamScore} - {match.AwayTeamScore}");
                }
            }
        }
    }
}
