using RugbyApiApp.Models;

namespace RugbyApiApp.Extensions
{
    public static class RugbyDataExtensions
    {
        /// <summary>
        /// Check if a team has been fetched recently
        /// </summary>
        public static bool IsRecentlyFetched(this Team team, TimeSpan? threshold = null)
        {
            threshold ??= TimeSpan.FromHours(24);
            return DateTime.UtcNow - team.UpdatedAt < threshold;
        }

        /// <summary>
        /// Get upcoming matches
        /// </summary>
        public static List<Match> GetUpcomingMatches(this IEnumerable<Match> matches)
        {
            return matches
                .Where(m => m.Date > DateTime.UtcNow && m.Status == "NS")
                .OrderBy(m => m.Date)
                .ToList();
        }

        /// <summary>
        /// Get completed matches
        /// </summary>
        public static List<Match> GetCompletedMatches(this IEnumerable<Match> matches)
        {
            return matches
                .Where(m => m.Status == "FT" || m.Status == "AET")
                .OrderByDescending(m => m.Date)
                .ToList();
        }

        /// <summary>
        /// Get team stats
        /// </summary>
        public static TeamStats GetStats(this Team team, IEnumerable<Match> allMatches)
        {
            var teamMatches = allMatches.Where(m => m.HomeTeamId == team.Id || m.AwayTeamId == team.Id).ToList();

            int wins = 0, losses = 0, draws = 0;
            int pointsFor = 0, pointsAgainst = 0;

            foreach (var match in teamMatches.GetCompletedMatches())
            {
                bool isHome = match.HomeTeamId == team.Id;
                int teamScore = isHome ? match.HomeTeamScore ?? 0 : match.AwayTeamScore ?? 0;
                int opponentScore = isHome ? match.AwayTeamScore ?? 0 : match.HomeTeamScore ?? 0;

                pointsFor += teamScore;
                pointsAgainst += opponentScore;

                if (teamScore > opponentScore)
                    wins++;
                else if (teamScore < opponentScore)
                    losses++;
                else
                    draws++;
            }

            return new TeamStats
            {
                TeamId = team.Id,
                TeamName = team.Name,
                Wins = wins,
                Losses = losses,
                Draws = draws,
                PointsFor = pointsFor,
                PointsAgainst = pointsAgainst,
                PointDifference = pointsFor - pointsAgainst,
                TotalMatches = teamMatches.Count
            };
        }

        /// <summary>
        /// Format match result as string
        /// </summary>
        public static string FormatScore(this Match match)
        {
            if (!match.HomeTeamScore.HasValue || !match.AwayTeamScore.HasValue)
                return "- vs -";

            return $"{match.HomeTeamScore} - {match.AwayTeamScore}";
        }
    }

    public class TeamStats
    {
        public int TeamId { get; set; }
        public string? TeamName { get; set; }
        public int Wins { get; set; }
        public int Losses { get; set; }
        public int Draws { get; set; }
        public int PointsFor { get; set; }
        public int PointsAgainst { get; set; }
        public int PointDifference { get; set; }
        public int TotalMatches { get; set; }

        public double WinPercentage => TotalMatches > 0 ? (double)Wins / TotalMatches * 100 : 0;

        public override string ToString()
        {
            return $"{TeamName}: {Wins}W-{Draws}D-{Losses}L | Pts {PointsFor}({PointDifference:+#;-#;0})";
        }
    }
}
