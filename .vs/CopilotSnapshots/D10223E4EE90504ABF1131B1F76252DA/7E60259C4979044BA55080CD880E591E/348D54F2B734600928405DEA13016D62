using Microsoft.EntityFrameworkCore;
using RugbyApiApp.Data;
using RugbyApiApp.Models;

namespace RugbyApiApp.Services
{
    public class DataService
    {
        private readonly RugbyDbContext _context;

        public DataService(RugbyDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Add or update a team
        /// </summary>
        public async Task<Team> UpsertTeamAsync(int teamId, string? name, string? code, string? flag, string? logo)
        {
            var existingTeam = await _context.Teams.FirstOrDefaultAsync(t => t.Id == teamId);

            if (existingTeam != null)
            {
                existingTeam.Name = name ?? existingTeam.Name;
                existingTeam.Code = code ?? existingTeam.Code;
                existingTeam.Flag = flag ?? existingTeam.Flag;
                existingTeam.Logo = logo ?? existingTeam.Logo;
                existingTeam.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingTeam = new Team
                {
                    Id = teamId,
                    Name = name,
                    Code = code,
                    Flag = flag,
                    Logo = logo,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Teams.Add(existingTeam);
            }

            await _context.SaveChangesAsync();
            return existingTeam;
        }

        /// <summary>
        /// Add or update a player
        /// </summary>
        public async Task<Player> UpsertPlayerAsync(int playerId, int teamId, string? name, string? position, int? number, string? photo, DateTime? dateOfBirth, string? nationality)
        {
            var existingPlayer = await _context.Players.FirstOrDefaultAsync(p => p.Id == playerId);

            if (existingPlayer != null)
            {
                existingPlayer.Name = name ?? existingPlayer.Name;
                existingPlayer.Position = position ?? existingPlayer.Position;
                existingPlayer.Number = number ?? existingPlayer.Number;
                existingPlayer.Photo = photo ?? existingPlayer.Photo;
                existingPlayer.DateOfBirth = dateOfBirth ?? existingPlayer.DateOfBirth;
                existingPlayer.Nationality = nationality ?? existingPlayer.Nationality;
                existingPlayer.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingPlayer = new Player
                {
                    Id = playerId,
                    TeamId = teamId,
                    Name = name,
                    Position = position,
                    Number = number,
                    Photo = photo,
                    DateOfBirth = dateOfBirth,
                    Nationality = nationality,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Players.Add(existingPlayer);
            }

            await _context.SaveChangesAsync();
            return existingPlayer;
        }

        /// <summary>
        /// Add or update a match
        /// </summary>
        public async Task<Match> UpsertMatchAsync(int matchId, int? leagueId, int? season, int homeTeamId, int awayTeamId, DateTime? date, string? status, string? venue, int? homeTeamScore, int? awayTeamScore)
        {
            var existingMatch = await _context.Matches.FirstOrDefaultAsync(m => m.Id == matchId);

            if (existingMatch != null)
            {
                existingMatch.LeagueId = leagueId ?? existingMatch.LeagueId;
                existingMatch.Season = season ?? existingMatch.Season;
                existingMatch.Date = date ?? existingMatch.Date;
                existingMatch.Status = status ?? existingMatch.Status;
                existingMatch.Venue = venue ?? existingMatch.Venue;
                existingMatch.HomeTeamScore = homeTeamScore ?? existingMatch.HomeTeamScore;
                existingMatch.AwayTeamScore = awayTeamScore ?? existingMatch.AwayTeamScore;
                existingMatch.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingMatch = new Match
                {
                    Id = matchId,
                    LeagueId = leagueId,
                    Season = season,
                    HomeTeamId = homeTeamId,
                    AwayTeamId = awayTeamId,
                    Date = date,
                    Status = status,
                    Venue = venue,
                    HomeTeamScore = homeTeamScore,
                    AwayTeamScore = awayTeamScore,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Matches.Add(existingMatch);
            }

            await _context.SaveChangesAsync();
            return existingMatch;
        }

        /// <summary>
        /// Get all teams
        /// </summary>
        public async Task<List<Team>> GetTeamsAsync()
        {
            return await _context.Teams.ToListAsync();
        }

        /// <summary>
        /// Get team with players
        /// </summary>
        public async Task<Team?> GetTeamWithPlayersAsync(int teamId)
        {
            return await _context.Teams
                .Include(t => t.Id)
                .FirstOrDefaultAsync(t => t.Id == teamId);
        }

        /// <summary>
        /// Get all matches with teams
        /// </summary>
        public async Task<List<Match>> GetMatchesAsync()
        {
            return await _context.Matches
                .Include(m => m.HomeTeam)
                .Include(m => m.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get matches for a season
        /// </summary>
        public async Task<List<Match>> GetMatchesBySeasonAsync(int season)
        {
            return await _context.Matches
                .Where(m => m.Season == season)
                .Include(m => m.HomeTeam)
                .Include(m => m.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Clear all data
        /// </summary>
        public async Task ClearAllDataAsync()
        {
            _context.Matches.RemoveRange(_context.Matches);
            _context.Players.RemoveRange(_context.Players);
            _context.Teams.RemoveRange(_context.Teams);
            _context.Leagues.RemoveRange(_context.Leagues);
            await _context.SaveChangesAsync();
        }
    }
}
