# Country Support Implementation Guide

## Overview

Added comprehensive Country support to the rugby API application with CDN-optimized flag images. Countries are now fetched from the API and cached efficiently using the `IsDataComplete` pattern.

## What Was Added

### 1. Country Model ?

**File:** `Models/Country.cs`

```csharp
public class Country
{
    public int Id { get; set; }
    public string? Name { get; set; }
    public string? Code { get; set; }
    public string? Flag { get; set; }  // CDN URL
    public bool IsDataComplete { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}
```

### 2. Country DTO ?

**File:** `DTOs/LeagueResponse.cs` (existing, contains CountryResponse)

```csharp
public class CountryResponse
{
    public int? Id { get; set; }
    public string? Name { get; set; }
    public string? Code { get; set; }
    public string? Flag { get; set; }
}
```

### 3. Database Context ?

Updated `Data/RugbyDbContext.cs` to include:
```csharp
public DbSet<Country> Countries { get; set; }
```

### 4. API Client Methods ?

**File:** `Services/RugbyApiClient.cs`

Added:
```csharp
// Get all countries
public async Task<List<CountryResponse>?> GetCountriesAsync(int page = 1)

// Get country by ID
public async Task<CountryResponse?> GetCountryAsync(int countryId)
```

### 5. Data Service Methods ?

**File:** `Services/DataService.cs`

Added:
```csharp
// Upsert country (auto-marks complete)
public async Task<Country> UpsertCountryAsync(int countryId, string? name, string? code, string? flag)

// Get all countries
public async Task<List<Country>> GetCountriesAsync()

// Get country by ID
public async Task<Country?> GetCountryAsync(int countryId)

// Get country by code
public async Task<Country?> GetCountryByCodeAsync(string code)

// Get incomplete countries
public async Task<List<Country>> GetIncompleteCountriesAsync()
```

### 6. Application Flow ?

**File:** `Program.cs`

Added:
- `FetchAndStoreCountriesAsync()` - Fetches and stores countries
- Updated `Main()` - Calls country fetch first (before seasons/leagues)
- Updated `DisplayStoredDataAsync()` - Shows country information

## Data Completion

Countries follow the leaf-node pattern:
- **IsDataComplete** = `false` initially
- **IsDataComplete** = `true` after successful API fetch
- Next run will skip API call if all complete

## API Endpoints

### Get All Countries
```http
GET /countries?page=1
```

### Get Country by ID
```http
GET /countries/{id}
```

## CDN Optimization

Country flags are automatically converted to CDN URLs:
```csharp
var cdnFlag = RugbyApiClient.ConvertToCdnUrl(countryResponse.Flag);
// api-sports.io URL ? bl-media-api-sports.b-cdn.net URL
```

## Usage Examples

### Fetch Countries
```csharp
var countries = await apiClient.GetCountriesAsync(page: 1);
foreach (var country in countries)
{
    var cdnFlag = RugbyApiClient.ConvertToCdnUrl(country.Flag);
    await dataService.UpsertCountryAsync(country.Id.Value, country.Name, country.Code, cdnFlag);
}
```

### Query Countries
```csharp
// Get all countries
var allCountries = await dataService.GetCountriesAsync();

// Get specific country
var england = await dataService.GetCountryAsync(1);

// Get country by code
var france = await dataService.GetCountryByCodeAsync("FR");

// Get incomplete countries (for refetch)
var incompleteCountries = await dataService.GetIncompleteCountriesAsync();
```

### Check Completion
```csharp
var stats = await dataService.GetCompletionStatsAsync();
Console.WriteLine($"Countries: {stats.CountryCompletionPercent:F1}% complete");
```

## Database Schema

```sql
CREATE TABLE Countries (
    Id INTEGER PRIMARY KEY,
    Name TEXT,
    Code TEXT,
    Flag TEXT,                  -- CDN URL
    IsDataComplete BOOLEAN DEFAULT 0,
    CreatedAt DATETIME,
    UpdatedAt DATETIME
);
```

## Relationships

```
Countries (Independent)
    ? Referenced by
Leagues (via CountryName/CountryCode/CountryFlag)
```

Note: Countries are stored independently from League references to:
- Avoid redundant storage
- Enable separate country queries
- Support country-level analytics

## Completion Statistics

The `DataCompletionStats` now includes:
```csharp
public int TotalCountries { get; set; }
public int CompleteCountries { get; set; }
public double CountryCompletionPercent { get; }
```

Sample output:
```
=== Data Completion Statistics ===
Seasons:   5/5 (100.0%)
Countries: 220/220 (100.0%)
Leagues:   25/25 (100.0%)
Teams:     38/38 (100.0%)
Players:   450/450 (100.0%)
Matches:   321/321 (100.0%)
```

## Application Flow

### First Run
```
1. Fetch Countries ? Store with CDN flags ? Mark complete
2. Fetch Seasons ? Store ? Mark complete
3. Fetch Leagues ? Store ? Mark complete
4. Fetch Teams ? Store
5. Fetch Players ? Store ? Mark teams complete
6. Display stats
```

### Subsequent Runs
```
1. Check incomplete countries ? SKIP (all complete)
2. Check incomplete seasons ? SKIP (all complete)
3. Check incomplete leagues ? SKIP (all complete)
4. Check incomplete teams ? SKIP (all complete)
5. Display stats
```

## Benefits

? **Complete Geographic Data** - All countries available  
? **CDN Optimized Flags** - Fast flag image delivery  
? **Efficient Caching** - Skip redundant country fetches  
? **Complete Stats** - See country completion in stats  
? **Easy Queries** - Get countries by ID or code  
? **Audit Trail** - CreatedAt/UpdatedAt timestamps  

## Files Modified

| File | Change |
|------|--------|
| `Models/Country.cs` | Created new |
| `Data/RugbyDbContext.cs` | Added Countries DbSet |
| `Services/RugbyApiClient.cs` | Added GetCountriesAsync() |
| `Services/DataService.cs` | Added 5 country methods |
| `Program.cs` | Added FetchAndStoreCountriesAsync() |

## Migration from Existing

If upgrading from previous version:

```csharp
// Countries table will be created automatically on first run
// via: context.Database.EnsureCreated()

// Can query leagues for country data:
var leagues = await dataService.GetLeaguesAsync();
var countryNames = leagues.Select(l => l.CountryName).Distinct();
```

## Performance Impact

| Operation | Impact |
|-----------|--------|
| API calls (1st run) | +1 call (countries) |
| API calls (2nd+ run) | 0 calls (cached) |
| Database size | +1 table (Countries) |
| Query speed | Negligible |
| Storage per country | ~100 bytes |

## Example Scenarios

### Scenario 1: Get All Countries by Continent
```csharp
var countries = await dataService.GetCountriesAsync();
var europeanCodes = new[] { "GB", "FR", "IT", "ES", "DE" };
var european = countries.Where(c => europeanCodes.Contains(c.Code)).ToList();
```

### Scenario 2: Verify Country Coverage
```csharp
var leagues = await dataService.GetLeaguesAsync();
var leagueCountries = leagues.Select(l => l.CountryName).Distinct();

var allCountries = await dataService.GetCountriesAsync();
var missing = leagueCountries.Except(allCountries.Select(c => c.Name)).ToList();

Console.WriteLine($"Countries in leagues but not in countries table: {missing.Count}");
```

### Scenario 3: Build Country Dropdown
```csharp
var countries = await dataService.GetCountriesAsync();
var dropdown = countries.Select(c => new { 
    code = c.Code, 
    name = c.Name, 
    flagUrl = c.Flag 
}).ToList();
```

## Troubleshooting

### No Countries Found
```csharp
var countries = await dataService.GetCountriesAsync();
if (countries.Count == 0)
{
    Console.WriteLine("No countries in database, need to fetch from API");
    var incomplete = await dataService.GetIncompleteCountriesAsync();
    Console.WriteLine($"Incomplete: {incomplete.Count}");
}
```

### Reset Countries
```csharp
// Clear all countries
var countries = await dataService.GetCountriesAsync();
foreach (var c in countries)
{
    // Mark for refetch (if needed)
}

// Or clear everything
await dataService.ClearAllDataAsync();
```

## Future Enhancements

Potential additions:
- Country population data
- Country rugby ranking/statistics
- Timezone information
- Regional groupings
- Flag image optimization

## Build Status

? All files compile successfully  
? No compilation errors  
? Database schema compatible  
? Ready for production  

## Summary

Countries are now fully integrated into the rugby API application with:
- **Complete country data** from the API
- **CDN-optimized flag images** for fast delivery
- **Efficient caching** via IsDataComplete pattern
- **Flexible querying** by ID or code
- **Integrated statistics** with other data types

The feature is backward compatible and requires no migration from existing installations.
