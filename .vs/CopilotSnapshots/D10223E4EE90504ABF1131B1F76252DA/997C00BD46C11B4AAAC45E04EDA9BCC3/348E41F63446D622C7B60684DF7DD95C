using RugbyApiApp.Data;
using RugbyApiApp.Extensions;
using RugbyApiApp.Models;
using Microsoft.EntityFrameworkCore;

namespace RugbyApiApp.Examples
{
    /// <summary>
    /// Example queries and use cases for the Rugby API Application
    /// Uncomment any examples in Program.cs to use them
    /// </summary>
    public static class RugbyQueryExamples
    {
        /// <summary>
        /// Example: Get team statistics and standings
        /// </summary>
        public static void Example_TeamStandings()
        {
            using (var context = new RugbyDbContext())
            {
                var allGames = context.Games
                    .Include(g => g.HomeTeam)
                    .Include(g => g.AwayTeam)
                    .ToList();

                var teams = context.Teams.ToList();
                var standings = teams
                    .Select(t => t.GetStats(allGames))
                    .OrderByDescending(s => s.Wins)
                    .ThenByDescending(s => s.PointDifference)
                    .ToList();

                Console.WriteLine("\n=== League Standings ===");
                foreach (var stat in standings)
                {
                    Console.WriteLine(stat);
                }
            }
        }

        /// <summary>
        /// Example: Find upcoming games
        /// </summary>
        public static void Example_UpcomingGames()
        {
            using (var context = new RugbyDbContext())
            {
                var upcomingGames = context.Games
                    .Include(g => g.HomeTeam)
                    .Include(g => g.AwayTeam)
                    .ToList()
                    .GetUpcomingGames()
                    .Take(10);

                Console.WriteLine("\n=== Upcoming Games ===");
                foreach (var game in upcomingGames)
                {
                    var homeTeam = game.HomeTeam?.Name ?? "Unknown";
                    var awayTeam = game.AwayTeam?.Name ?? "Unknown";
                    Console.WriteLine($"{game.Date:yyyy-MM-dd HH:mm} | {homeTeam} vs {awayTeam}");
                }
            }
        }

        /// <summary>
        /// Example: Get recent game results
        /// </summary>
        public static void Example_RecentResults()
        {
            using (var context = new RugbyDbContext())
            {
                var recentGames = context.Games
                    .Include(g => g.HomeTeam)
                    .Include(g => g.AwayTeam)
                    .Where(g => g.Status == "FT" || g.Status == "AET")
                    .OrderByDescending(g => g.Date)
                    .Take(10)
                    .ToList();

                Console.WriteLine("\n=== Recent Results ===");
                foreach (var game in recentGames)
                {
                    var homeTeam = game.HomeTeam?.Name ?? "Unknown";
                    var awayTeam = game.AwayTeam?.Name ?? "Unknown";
                    var score = game.FormatScore();
                    Console.WriteLine($"{homeTeam} {score} {awayTeam}");
                }
            }
        }

        /// <summary>
        /// Example: Get games by league/season filter
        /// </summary>
        public static void Example_GamesByLeague()
        {
            using (var context = new RugbyDbContext())
            {
                int leagueId = 1; // Premier League example
                var leagueGames = context.Games
                    .Include(g => g.HomeTeam)
                    .Include(g => g.AwayTeam)
                    .Where(g => g.LeagueId == leagueId)
                    .OrderByDescending(g => g.Date)
                    .Take(5)
                    .ToList();

                Console.WriteLine($"\n=== League {leagueId} Recent Games ===");
                foreach (var game in leagueGames)
                {
                    Console.WriteLine($"{game.Date:yyyy-MM-dd} | {game.HomeTeam?.Name} vs {game.AwayTeam?.Name}");
                }
            }
        }

        /// <summary>
        /// Example: Get team's head-to-head record
        /// </summary>
        public static void Example_HeadToHead(int team1Id, int team2Id)
        {
            using (var context = new RugbyDbContext())
            {
                var h2h = context.Games
                    .Include(g => g.HomeTeam)
                    .Include(g => g.AwayTeam)
                    .Where(g => 
                        (g.HomeTeamId == team1Id && g.AwayTeamId == team2Id) ||
                        (g.HomeTeamId == team2Id && g.AwayTeamId == team1Id))
                    .OrderByDescending(g => g.Date)
                    .ToList();

                var team1 = context.Teams.Find(team1Id);
                var team2 = context.Teams.Find(team2Id);

                Console.WriteLine($"\n=== Head to Head: {team1?.Name} vs {team2?.Name} ===");
                Console.WriteLine($"Total Games: {h2h.Count}");

                foreach (var game in h2h.Take(5))
                {
                    var score = game.FormatScore();
                    Console.WriteLine($"{game.Date:yyyy-MM-dd} | {game.HomeTeam?.Name} {score} {game.AwayTeam?.Name}");
                }
            }
        }

        /// <summary>
        /// Example: Get highest scoring games
        /// </summary>
        public static void Example_HighestScoringGames()
        {
            using (var context = new RugbyDbContext())
            {
                var topGames = context.Games
                    .Include(g => g.HomeTeam)
                    .Include(g => g.AwayTeam)
                    .AsEnumerable()
                    .Where(g => g.HomeTeamScore.HasValue && g.AwayTeamScore.HasValue)
                    .OrderByDescending(g => (g.HomeTeamScore ?? 0) + (g.AwayTeamScore ?? 0))
                    .Take(10)
                    .ToList();

                Console.WriteLine("\n=== Highest Scoring Games ===");
                foreach (var game in topGames)
                {
                    int totalScore = (game.HomeTeamScore ?? 0) + (game.AwayTeamScore ?? 0);
                    Console.WriteLine($"{game.HomeTeam?.Name} {game.FormatScore()} {game.AwayTeam?.Name} (Total: {totalScore})");
                }
            }
        }

        /// <summary>
        /// Example: Get teams that need data refresh
        /// </summary>
        public static void Example_StaleTeamData()
        {
            using (var context = new RugbyDbContext())
            {
                var staleTeams = context.Teams
                    .Where(t => (DateTime.UtcNow - t.UpdatedAt) > TimeSpan.FromHours(24))
                    .ToList();

                Console.WriteLine($"\n=== Teams needing refresh (older than 24 hours) ===");
                Console.WriteLine($"Count: {staleTeams.Count}");
                foreach (var team in staleTeams.Take(5))
                {
                    Console.WriteLine($"  - {team.Name} (updated {(DateTime.UtcNow - team.UpdatedAt).TotalHours:F1} hours ago)");
                }
            }
        }

        /// <summary>
        /// Example: Search teams by name
        /// </summary>
        public static void Example_SearchTeams(string searchTerm)
        {
            using (var context = new RugbyDbContext())
            {
                var results = context.Teams
                    .Where(t => t.Name != null && t.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                    .ToList();

                Console.WriteLine($"\n=== Search Results for '{searchTerm}' ===");
                foreach (var team in results)
                {
                    Console.WriteLine($"  - {team.Name} ({team.Code})");
                }
            }
        }

        /// <summary>
        /// Example: Export game data to CSV format
        /// </summary>
        public static void Example_ExportGames(string filePath = "games_export.csv")
        {
            using (var context = new RugbyDbContext())
            {
                var games = context.Games
                    .Include(g => g.HomeTeam)
                    .Include(g => g.AwayTeam)
                    .ToList();

                using (var writer = new StreamWriter(filePath))
                {
                    writer.WriteLine("Date,HomeTeam,AwayTeam,HomeScore,AwayScore,Status,Venue");
                    foreach (var game in games)
                    {
                        writer.WriteLine($"{game.Date:yyyy-MM-dd},{game.HomeTeam?.Name},{game.AwayTeam?.Name},{game.HomeTeamScore},{game.AwayTeamScore},{game.Status},{game.Venue}");
                    }
                }

                Console.WriteLine($"\n✓ Exported {games.Count} games to {filePath}");
            }
        }

        /// <summary>
        /// Example: Get database statistics
        /// </summary>
        public static void Example_DatabaseStats()
        {
            using (var context = new RugbyDbContext())
            {
                int teamCount = context.Teams.Count();
                int playerCount = context.Players.Count();
                int gameCount = context.Games.Count();
                int leagueCount = context.Leagues.Count();

                var oldestGame = context.Games.OrderBy(g => g.Date).FirstOrDefault();
                var newestGame = context.Games.OrderByDescending(g => g.Date).FirstOrDefault();

                Console.WriteLine("\n=== Database Statistics ===");
                Console.WriteLine($"Teams: {teamCount}");
                Console.WriteLine($"Players: {playerCount}");
                Console.WriteLine($"Games: {gameCount}");
                Console.WriteLine($"Leagues: {leagueCount}");
                Console.WriteLine($"Date Range: {oldestGame?.Date:yyyy-MM-dd} to {newestGame?.Date:yyyy-MM-dd}");
            }
        }
    }
}
