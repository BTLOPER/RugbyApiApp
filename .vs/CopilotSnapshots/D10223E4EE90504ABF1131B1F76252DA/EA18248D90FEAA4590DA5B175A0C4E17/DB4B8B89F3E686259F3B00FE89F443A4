# Countries Feature - Quick Reference

## What It Does

Fetches all rugby-playing countries from the API with CDN-optimized flag images.

## Key Features

? Complete country data  
? CDN-optimized flags  
? Efficient caching  
? Easy queries by ID or code  

## Quick Usage

### Fetch Countries
```csharp
// Gets called automatically in Program.cs
var countries = await apiClient.GetCountriesAsync();
```

### Query Countries
```csharp
// Get all
var all = await dataService.GetCountriesAsync();

// Get by ID
var country = await dataService.GetCountryAsync(1);

// Get by code
var france = await dataService.GetCountryByCodeAsync("FR");

// Get incomplete (for refetch)
var needFetch = await dataService.GetIncompleteCountriesAsync();
```

### Flag URLs (CDN Optimized)
```csharp
// Automatically converted during fetch
var cdnUrl = RugbyApiClient.ConvertToCdnUrl(apiUrl);

// Already stored as CDN in Country.Flag
var country = await dataService.GetCountryAsync(1);
Console.WriteLine(country.Flag);  // Already CDN URL
```

## Completion Tracking

```csharp
var stats = await dataService.GetCompletionStatsAsync();
Console.WriteLine($"Countries: {stats.CountryCompletionPercent:F1}%");

// Output:
// Countries: 100.0%
```

## Data Model

```csharp
public class Country
{
    public int Id { get; set; }
    public string? Name { get; set; }
    public string? Code { get; set; }
    public string? Flag { get; set; }  // CDN URL
    public bool IsDataComplete { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}
```

## API Endpoints Used

```http
GET /countries?page=1      # Get all countries
GET /countries/{id}        # Get specific country
```

## Database Table

```sql
Countries (
  Id INTEGER PRIMARY KEY,
  Name TEXT,
  Code TEXT,
  Flag TEXT,                        -- CDN URL
  IsDataComplete BOOLEAN DEFAULT 0,
  CreatedAt DATETIME,
  UpdatedAt DATETIME
)
```

## Common Tasks

### Display All Countries with Flags
```csharp
var countries = await dataService.GetCountriesAsync();
foreach (var country in countries)
{
    Console.WriteLine($"{country.Name} ({country.Code})");
    Console.WriteLine($"  Flag: {country.Flag}");
}
```

### Find Country by Code
```csharp
var england = await dataService.GetCountryByCodeAsync("GB");
if (england != null)
{
    Console.WriteLine($"Found: {england.Name}");
}
```

### Check if Countries are Complete
```csharp
var incomplete = await dataService.GetIncompleteCountriesAsync();
if (incomplete.Count == 0)
{
    Console.WriteLine("All countries fetched, API will be skipped next run");
}
```

### Get Country Code Mappings
```csharp
var countries = await dataService.GetCountriesAsync();
var codeMap = countries.ToDictionary(c => c.Code, c => c.Name);
```

## Integration Points

### In Leagues
Leagues store country info:
```csharp
public class League
{
    public string? CountryName { get; set; }   // Links to Country.Name
    public string? CountryCode { get; set; }   // Links to Country.Code
    public string? CountryFlag { get; set; }   // Links to Country.Flag (CDN)
}
```

### In Application Flow
Order of operations:
```
1. Fetch Countries
2. Fetch Seasons
3. Fetch Leagues (references countries)
4. Fetch Teams
5. Fetch Players
```

## Completion Stats

Part of overall statistics:
```
=== Data Completion Statistics ===
Seasons:   5/5 (100.0%)
Countries: 220/220 (100.0%)    ? NEW
Leagues:   25/25 (100.0%)
Teams:     38/38 (100.0%)
Players:   450/450 (100.0%)
Matches:   321/321 (100.0%)
```

## Caching Behavior

| Run | Countries | API Calls | Notes |
|-----|-----------|-----------|-------|
| 1st | 0 ? 220 | 1 | Fetches all |
| 2nd | 220 | 0 | SKIPPED (all complete) |
| 3rd | 220 | 0 | SKIPPED (all complete) |

## CDN Optimization

Flags are automatically converted:
```
Original API URL:
https://media.api-sports.io/rugby/countries/1.png

CDN URL:
https://bl-media-api-sports.b-cdn.net/rugby/countries/1.png
```

## Error Handling

```csharp
try
{
    var countries = await apiClient.GetCountriesAsync();
    // Process...
    foreach (var c in countries)
    {
        await dataService.UpsertCountryAsync(c.Id.Value, c.Name, c.Code, flag);
    }
}
catch (HttpRequestException ex)
{
    Console.WriteLine($"Failed to fetch countries: {ex.Message}");
    // Will retry next run
}
```

## Files Changed

- ? `Models/Country.cs` - New model
- ? `Data/RugbyDbContext.cs` - Added Countries DbSet
- ? `Services/RugbyApiClient.cs` - Added GetCountriesAsync()
- ? `Services/DataService.cs` - Added country methods
- ? `Program.cs` - Added country fetching

## Status

? Implemented  
? Build successful  
? Ready for use  

## See Also

- Full guide: `COUNTRIES_GUIDE.md`
- Models: `Models/Country.cs`
- Data service: `Services/DataService.cs`
- API client: `Services/RugbyApiClient.cs`
