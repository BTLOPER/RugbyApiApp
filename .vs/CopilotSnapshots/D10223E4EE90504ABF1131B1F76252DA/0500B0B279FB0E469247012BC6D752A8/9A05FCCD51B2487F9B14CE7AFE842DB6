using Microsoft.EntityFrameworkCore;
using RugbyApiApp.Data;
using RugbyApiApp.Models;

namespace RugbyApiApp.Services
{
    public class DataService
    {
        private readonly RugbyDbContext _context;

        public DataService(RugbyDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Add or update a season and mark as complete (no children)
        /// </summary>
        public async Task<Season> UpsertSeasonAsync(int seasonId, int? year, DateTime? startDate, DateTime? endDate, bool isCurrent)
        {
            var existingSeason = await _context.Seasons.FirstOrDefaultAsync(s => s.Id == seasonId);

            if (existingSeason != null)
            {
                existingSeason.Year = year ?? existingSeason.Year;
                existingSeason.StartDate = startDate ?? existingSeason.StartDate;
                existingSeason.EndDate = endDate ?? existingSeason.EndDate;
                existingSeason.IsCurrent = isCurrent;
                existingSeason.IsDataComplete = true;
                existingSeason.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingSeason = new Season
                {
                    Id = seasonId,
                    Year = year,
                    StartDate = startDate,
                    EndDate = endDate,
                    IsCurrent = isCurrent,
                    IsDataComplete = true,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Seasons.Add(existingSeason);
            }

            await _context.SaveChangesAsync();
            return existingSeason;
        }

        /// <summary>
        /// Add or update a league and mark as complete (no children)
        /// </summary>
        public async Task<League> UpsertLeagueAsync(int leagueId, string? name, string? type, string? logo, string? countryName, string? countryCode, string? countryFlag)
        {
            var existingLeague = await _context.Leagues.FirstOrDefaultAsync(l => l.Id == leagueId);

            if (existingLeague != null)
            {
                existingLeague.Name = name ?? existingLeague.Name;
                existingLeague.Type = type ?? existingLeague.Type;
                existingLeague.Logo = logo ?? existingLeague.Logo;
                existingLeague.CountryName = countryName ?? existingLeague.CountryName;
                existingLeague.CountryCode = countryCode ?? existingLeague.CountryCode;
                existingLeague.CountryFlag = countryFlag ?? existingLeague.CountryFlag;
                existingLeague.IsDataComplete = true;
                existingLeague.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingLeague = new League
                {
                    Id = leagueId,
                    Name = name,
                    Type = type,
                    Logo = logo,
                    CountryName = countryName,
                    CountryCode = countryCode,
                    CountryFlag = countryFlag,
                    IsDataComplete = true,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Leagues.Add(existingLeague);
            }

            await _context.SaveChangesAsync();
            return existingLeague;
        }

        /// <summary>
        /// Add or update a team (completion marked immediately as teams are now leaf nodes)
        /// </summary>
        public async Task<Team> UpsertTeamAsync(int teamId, string? name, string? code, string? flag, string? logo)
        {
            var existingTeam = await _context.Teams.FirstOrDefaultAsync(t => t.Id == teamId);

            if (existingTeam != null)
            {
                existingTeam.Name = name ?? existingTeam.Name;
                existingTeam.Code = code ?? existingTeam.Code;
                existingTeam.Flag = flag ?? existingTeam.Flag;
                existingTeam.Logo = logo ?? existingTeam.Logo;
                existingTeam.IsDataComplete = true;
                existingTeam.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingTeam = new Team
                {
                    Id = teamId,
                    Name = name,
                    Code = code,
                    Flag = flag,
                    Logo = logo,
                    IsDataComplete = true,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Teams.Add(existingTeam);
            }

            await _context.SaveChangesAsync();
            return existingTeam;
        }

        /// <summary>
        /// Add or update a game and mark as complete only if both teams are complete
        /// </summary>
        public async Task<Game> UpsertGameAsync(int gameId, int? leagueId, int? season, int homeTeamId, int awayTeamId, DateTime? date, string? status, string? venue, int? homeTeamScore, int? awayTeamScore)
        {
            var existingGame = await _context.Games.FirstOrDefaultAsync(g => g.Id == gameId);

            // Check if both teams have complete data
            var homeTeam = await _context.Teams.FirstOrDefaultAsync(t => t.Id == homeTeamId);
            var awayTeam = await _context.Teams.FirstOrDefaultAsync(t => t.Id == awayTeamId);
            var isComplete = homeTeam?.IsDataComplete == true && awayTeam?.IsDataComplete == true;

            if (existingGame != null)
            {
                existingGame.LeagueId = leagueId ?? existingGame.LeagueId;
                existingGame.Season = season ?? existingGame.Season;
                existingGame.Date = date ?? existingGame.Date;
                existingGame.Status = status ?? existingGame.Status;
                existingGame.Venue = venue ?? existingGame.Venue;
                existingGame.HomeTeamScore = homeTeamScore ?? existingGame.HomeTeamScore;
                existingGame.AwayTeamScore = awayTeamScore ?? existingGame.AwayTeamScore;
                existingGame.IsDataComplete = isComplete;
                existingGame.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingGame = new Game
                {
                    Id = gameId,
                    LeagueId = leagueId,
                    Season = season,
                    HomeTeamId = homeTeamId,
                    AwayTeamId = awayTeamId,
                    Date = date,
                    Status = status,
                    Venue = venue,
                    HomeTeamScore = homeTeamScore,
                    AwayTeamScore = awayTeamScore,
                    IsDataComplete = isComplete,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Games.Add(existingGame);
            }

            await _context.SaveChangesAsync();
            return existingGame;
        }

        /// <summary>
        /// Add or update a country and mark as complete (no children)
        /// </summary>
        public async Task<Country> UpsertCountryAsync(int countryId, string? name, string? code, string? flag)
        {
            var existingCountry = await _context.Countries.FirstOrDefaultAsync(c => c.Id == countryId);

            if (existingCountry != null)
            {
                existingCountry.Name = name ?? existingCountry.Name;
                existingCountry.Code = code ?? existingCountry.Code;
                existingCountry.Flag = flag ?? existingCountry.Flag;
                existingCountry.IsDataComplete = true;
                existingCountry.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingCountry = new Country
                {
                    Id = countryId,
                    Name = name,
                    Code = code,
                    Flag = flag,
                    IsDataComplete = true,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Countries.Add(existingCountry);
            }

            await _context.SaveChangesAsync();
            return existingCountry;
        }

        /// <summary>
        /// Get incomplete seasons (to fetch if missing)
        /// </summary>
        public async Task<List<Season>> GetIncompleteSeasonAsync()
        {
            return await _context.Seasons
                .Where(s => !s.IsDataComplete)
                .ToListAsync();
        }

        /// <summary>
        /// Get incomplete leagues
        /// </summary>
        public async Task<List<League>> GetIncompleteLeaguesAsync()
        {
            return await _context.Leagues
                .Where(l => !l.IsDataComplete)
                .ToListAsync();
        }

        /// <summary>
        /// Get teams with incomplete data
        /// </summary>
        public async Task<List<Team>> GetIncompleteTeamsAsync()
        {
            return await _context.Teams
                .Where(t => !t.IsDataComplete)
                .ToListAsync();
        }

        /// <summary>
        /// Get games with incomplete data
        /// </summary>
        public async Task<List<Game>> GetIncompleteGamesAsync()
        {
            return await _context.Games
                .Where(g => !g.IsDataComplete)
                .ToListAsync();
        }

        /// <summary>
        /// Get incomplete countries
        /// </summary>
        public async Task<List<Country>> GetIncompleteCountriesAsync()
        {
            return await _context.Countries
                .Where(c => !c.IsDataComplete)
                .ToListAsync();
        }

        /// <summary>
        /// Get completion statistics
        /// </summary>
        public async Task<DataCompletionStats> GetCompletionStatsAsync()
        {
            return new DataCompletionStats
            {
                TotalSeasons = await _context.Seasons.CountAsync(),
                CompleteSeasons = await _context.Seasons.CountAsync(s => s.IsDataComplete),
                
                TotalCountries = await _context.Countries.CountAsync(),
                CompleteCountries = await _context.Countries.CountAsync(c => c.IsDataComplete),
                
                TotalLeagues = await _context.Leagues.CountAsync(),
                CompleteLeagues = await _context.Leagues.CountAsync(l => l.IsDataComplete),
                
                TotalTeams = await _context.Teams.CountAsync(),
                CompleteTeams = await _context.Teams.CountAsync(t => t.IsDataComplete),
                
                TotalGames = await _context.Games.CountAsync(),
                CompleteGames = await _context.Games.CountAsync(g => g.IsDataComplete),
            };
        }

        /// <summary>
        /// Get all seasons
        /// </summary>
        public async Task<List<Season>> GetSeasonsAsync()
        {
            return await _context.Seasons
                .OrderByDescending(s => s.Year)
                .ToListAsync();
        }

        /// <summary>
        /// Get current season
        /// </summary>
        public async Task<Season?> GetCurrentSeasonAsync()
        {
            return await _context.Seasons
                .FirstOrDefaultAsync(s => s.IsCurrent);
        }

        /// <summary>
        /// Get all leagues
        /// </summary>
        public async Task<List<League>> GetLeaguesAsync()
        {
            return await _context.Leagues
                .OrderBy(l => l.Name)
                .ToListAsync();
        }

        /// <summary>
        /// Get league by ID
        /// </summary>
        public async Task<League?> GetLeagueAsync(int leagueId)
        {
            return await _context.Leagues
                .FirstOrDefaultAsync(l => l.Id == leagueId);
        }

        /// <summary>
        /// Get all teams
        /// </summary>
        public async Task<List<Team>> GetTeamsAsync()
        {
            return await _context.Teams.ToListAsync();
        }

        /// <summary>
        /// Get all games with teams
        /// </summary>
        public async Task<List<Game>> GetGamesAsync()
        {
            return await _context.Games
                .Include(g => g.HomeTeam)
                .Include(g => g.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get games for a season
        /// </summary>
        public async Task<List<Game>> GetGamesBySeasonAsync(int season)
        {
            return await _context.Games
                .Where(g => g.Season == season)
                .Include(g => g.HomeTeam)
                .Include(g => g.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get games for a league
        /// </summary>
        public async Task<List<Game>> GetGamesByLeagueAsync(int leagueId)
        {
            return await _context.Games
                .Where(g => g.LeagueId == leagueId)
                .Include(g => g.HomeTeam)
                .Include(g => g.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get games for a league and season
        /// </summary>
        public async Task<List<Game>> GetGamesByLeagueAndSeasonAsync(int leagueId, int season)
        {
            return await _context.Games
                .Where(g => g.LeagueId == leagueId && g.Season == season)
                .Include(g => g.HomeTeam)
                .Include(g => g.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get games for a league across a range of seasons
        /// </summary>
        public async Task<List<Game>> GetGamesByLeagueAndSeasonRangeAsync(int leagueId, int startSeason, int endSeason)
        {
            return await _context.Games
                .Where(g => g.LeagueId == leagueId && g.Season >= startSeason && g.Season <= endSeason)
                .Include(g => g.HomeTeam)
                .Include(g => g.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get all countries
        /// </summary>
        public async Task<List<Country>> GetCountriesAsync()
        {
            return await _context.Countries
                .OrderBy(c => c.Name)
                .ToListAsync();
        }

        /// <summary>
        /// Get country by ID
        /// </summary>
        public async Task<Country?> GetCountryAsync(int countryId)
        {
            return await _context.Countries
                .FirstOrDefaultAsync(c => c.Id == countryId);
        }

        /// <summary>
        /// Get country by code
        /// </summary>
        public async Task<Country?> GetCountryByCodeAsync(string code)
        {
            return await _context.Countries
                .FirstOrDefaultAsync(c => c.Code == code);
        }

        /// <summary>
        /// Check if a team exists
        /// </summary>
        public async Task<bool> TeamExistsAsync(int teamId)
        {
            return await _context.Teams.AnyAsync(t => t.Id == teamId);
        }

        /// <summary>
        /// Clear all data
        /// </summary>
        public async Task ClearAllDataAsync()
        {
            _context.Games.RemoveRange(_context.Games);
            _context.Players.RemoveRange(_context.Players);
            _context.Teams.RemoveRange(_context.Teams);
            _context.Leagues.RemoveRange(_context.Leagues);
            _context.Seasons.RemoveRange(_context.Seasons);
            _context.Countries.RemoveRange(_context.Countries);
            await _context.SaveChangesAsync();
        }
    }

    /// <summary>
    /// Statistics about data completion across all entities
    /// </summary>
    public class DataCompletionStats
    {
        public int TotalSeasons { get; set; }
        public int CompleteSeasons { get; set; }
        public double SeasonCompletionPercent => TotalSeasons > 0 ? (CompleteSeasons * 100.0 / TotalSeasons) : 0;

        public int TotalCountries { get; set; }
        public int CompleteCountries { get; set; }
        public double CountryCompletionPercent => TotalCountries > 0 ? (CompleteCountries * 100.0 / TotalCountries) : 0;

        public int TotalLeagues { get; set; }
        public int CompleteLeagues { get; set; }
        public double LeagueCompletionPercent => TotalLeagues > 0 ? (CompleteLeagues * 100.0 / TotalLeagues) : 0;

        public int TotalTeams { get; set; }
        public int CompleteTeams { get; set; }
        public double TeamCompletionPercent => TotalTeams > 0 ? (CompleteTeams * 100.0 / TotalTeams) : 0;

        public int TotalGames { get; set; }
        public int CompleteGames { get; set; }
        public double GameCompletionPercent => TotalGames > 0 ? (CompleteGames * 100.0 / TotalGames) : 0;

        public override string ToString()
        {
            return $@"
=== Data Completion Statistics ===
Seasons:   {CompleteSeasons}/{TotalSeasons} ({SeasonCompletionPercent:F1}%)
Countries: {CompleteCountries}/{TotalCountries} ({CountryCompletionPercent:F1}%)
Leagues:   {CompleteLeagues}/{TotalLeagues} ({LeagueCompletionPercent:F1}%)
Teams:     {CompleteTeams}/{TotalTeams} ({TeamCompletionPercent:F1}%)
Games:     {CompleteGames}/{TotalGames} ({GameCompletionPercent:F1}%)";
        }
    }
}
