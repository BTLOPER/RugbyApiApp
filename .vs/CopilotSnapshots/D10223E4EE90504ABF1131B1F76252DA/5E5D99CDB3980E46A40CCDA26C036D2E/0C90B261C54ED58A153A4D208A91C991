using Microsoft.EntityFrameworkCore;
using RugbyApiApp.Data;
using RugbyApiApp.Models;

namespace RugbyApiApp.Services
{
    public class DataService
    {
        private readonly RugbyDbContext _context;

        public DataService(RugbyDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Add or update a season and mark as complete (no children)
        /// </summary>
        public async Task<Season> UpsertSeasonAsync(int seasonId, int? year, DateTime? startDate, DateTime? endDate, bool isCurrent)
        {
            var existingSeason = await _context.Seasons.FirstOrDefaultAsync(s => s.Id == seasonId);

            if (existingSeason != null)
            {
                existingSeason.Year = year ?? existingSeason.Year;
                existingSeason.StartDate = startDate ?? existingSeason.StartDate;
                existingSeason.EndDate = endDate ?? existingSeason.EndDate;
                existingSeason.IsCurrent = isCurrent;
                existingSeason.IsDataComplete = true;
                existingSeason.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingSeason = new Season
                {
                    Id = seasonId,
                    Year = year,
                    StartDate = startDate,
                    EndDate = endDate,
                    IsCurrent = isCurrent,
                    IsDataComplete = true,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Seasons.Add(existingSeason);
            }

            await _context.SaveChangesAsync();
            return existingSeason;
        }

        /// <summary>
        /// Add or update a league and mark as complete (no children)
        /// </summary>
        public async Task<League> UpsertLeagueAsync(int leagueId, string? name, string? type, string? logo, string? countryName, string? countryCode, string? countryFlag)
        {
            var existingLeague = await _context.Leagues.FirstOrDefaultAsync(l => l.Id == leagueId);

            if (existingLeague != null)
            {
                existingLeague.Name = name ?? existingLeague.Name;
                existingLeague.Type = type ?? existingLeague.Type;
                existingLeague.Logo = logo ?? existingLeague.Logo;
                existingLeague.CountryName = countryName ?? existingLeague.CountryName;
                existingLeague.CountryCode = countryCode ?? existingLeague.CountryCode;
                existingLeague.CountryFlag = countryFlag ?? existingLeague.CountryFlag;
                existingLeague.IsDataComplete = true;
                existingLeague.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingLeague = new League
                {
                    Id = leagueId,
                    Name = name,
                    Type = type,
                    Logo = logo,
                    CountryName = countryName,
                    CountryCode = countryCode,
                    CountryFlag = countryFlag,
                    IsDataComplete = true,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Leagues.Add(existingLeague);
            }

            await _context.SaveChangesAsync();
            return existingLeague;
        }

        /// <summary>
        /// Add or update a team (completion depends on players being fetched)
        /// </summary>
        public async Task<Team> UpsertTeamAsync(int teamId, string? name, string? code, string? flag, string? logo)
        {
            var existingTeam = await _context.Teams.FirstOrDefaultAsync(t => t.Id == teamId);

            if (existingTeam != null)
            {
                existingTeam.Name = name ?? existingTeam.Name;
                existingTeam.Code = code ?? existingTeam.Code;
                existingTeam.Flag = flag ?? existingTeam.Flag;
                existingTeam.Logo = logo ?? existingTeam.Logo;
                existingTeam.UpdatedAt = DateTime.UtcNow;
                // Don't change IsDataComplete here - it's managed separately
            }
            else
            {
                existingTeam = new Team
                {
                    Id = teamId,
                    Name = name,
                    Code = code,
                    Flag = flag,
                    Logo = logo,
                    IsDataComplete = false, // Will be set to true when all players fetched
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Teams.Add(existingTeam);
            }

            await _context.SaveChangesAsync();
            return existingTeam;
        }

        /// <summary>
        /// Add or update a player and mark as complete (no children)
        /// </summary>
        public async Task<Player> UpsertPlayerAsync(int playerId, int teamId, string? name, string? position, int? number, string? photo, DateTime? dateOfBirth, string? nationality)
        {
            var existingPlayer = await _context.Players.FirstOrDefaultAsync(p => p.Id == playerId);

            if (existingPlayer != null)
            {
                existingPlayer.Name = name ?? existingPlayer.Name;
                existingPlayer.Position = position ?? existingPlayer.Position;
                existingPlayer.Number = number ?? existingPlayer.Number;
                existingPlayer.Photo = photo ?? existingPlayer.Photo;
                existingPlayer.DateOfBirth = dateOfBirth ?? existingPlayer.DateOfBirth;
                existingPlayer.Nationality = nationality ?? existingPlayer.Nationality;
                existingPlayer.IsDataComplete = true;
                existingPlayer.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingPlayer = new Player
                {
                    Id = playerId,
                    TeamId = teamId,
                    Name = name,
                    Position = position,
                    Number = number,
                    Photo = photo,
                    DateOfBirth = dateOfBirth,
                    Nationality = nationality,
                    IsDataComplete = true,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Players.Add(existingPlayer);
            }

            await _context.SaveChangesAsync();
            return existingPlayer;
        }

        /// <summary>
        /// Add or update a match and mark as complete (no children)
        /// </summary>
        public async Task<Match> UpsertMatchAsync(int matchId, int? leagueId, int? season, int homeTeamId, int awayTeamId, DateTime? date, string? status, string? venue, int? homeTeamScore, int? awayTeamScore)
        {
            var existingMatch = await _context.Matches.FirstOrDefaultAsync(m => m.Id == matchId);

            if (existingMatch != null)
            {
                existingMatch.LeagueId = leagueId ?? existingMatch.LeagueId;
                existingMatch.Season = season ?? existingMatch.Season;
                existingMatch.Date = date ?? existingMatch.Date;
                existingMatch.Status = status ?? existingMatch.Status;
                existingMatch.Venue = venue ?? existingMatch.Venue;
                existingMatch.HomeTeamScore = homeTeamScore ?? existingMatch.HomeTeamScore;
                existingMatch.AwayTeamScore = awayTeamScore ?? existingMatch.AwayTeamScore;
                existingMatch.IsDataComplete = true;
                existingMatch.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingMatch = new Match
                {
                    Id = matchId,
                    LeagueId = leagueId,
                    Season = season,
                    HomeTeamId = homeTeamId,
                    AwayTeamId = awayTeamId,
                    Date = date,
                    Status = status,
                    Venue = venue,
                    HomeTeamScore = homeTeamScore,
                    AwayTeamScore = awayTeamScore,
                    IsDataComplete = true,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Matches.Add(existingMatch);
            }

            await _context.SaveChangesAsync();
            return existingMatch;
        }

        /// <summary>
        /// Add or update a country and mark as complete (no children)
        /// </summary>
        public async Task<Country> UpsertCountryAsync(int countryId, string? name, string? code, string? flag)
        {
            var existingCountry = await _context.Countries.FirstOrDefaultAsync(c => c.Id == countryId);

            if (existingCountry != null)
            {
                existingCountry.Name = name ?? existingCountry.Name;
                existingCountry.Code = code ?? existingCountry.Code;
                existingCountry.Flag = flag ?? existingCountry.Flag;
                existingCountry.IsDataComplete = true;
                existingCountry.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingCountry = new Country
                {
                    Id = countryId,
                    Name = name,
                    Code = code,
                    Flag = flag,
                    IsDataComplete = true,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Countries.Add(existingCountry);
            }

            await _context.SaveChangesAsync();
            return existingCountry;
        }

        /// <summary>
        /// Mark a team as complete after all its players have been fetched
        /// </summary>
        public async Task MarkTeamDataCompleteAsync(int teamId)
        {
            var team = await _context.Teams.FirstOrDefaultAsync(t => t.Id == teamId);
            if (team != null)
            {
                team.IsDataComplete = true;
                team.UpdatedAt = DateTime.UtcNow;
                await _context.SaveChangesAsync();
            }
        }

        /// <summary>
        /// Get incomplete seasons (to fetch if missing)
        /// </summary>
        public async Task<List<Season>> GetIncompleteSeasonAsync()
        {
            return await _context.Seasons
                .Where(s => !s.IsDataComplete)
                .ToListAsync();
        }

        /// <summary>
        /// Get incomplete leagues
        /// </summary>
        public async Task<List<League>> GetIncompleteLeaguesAsync()
        {
            return await _context.Leagues
                .Where(l => !l.IsDataComplete)
                .ToListAsync();
        }

        /// <summary>
        /// Get teams with incomplete data (players not yet fetched)
        /// </summary>
        public async Task<List<Team>> GetIncompleteTeamsAsync()
        {
            return await _context.Teams
                .Where(t => !t.IsDataComplete)
                .ToListAsync();
        }

        /// <summary>
        /// Get players with incomplete data
        /// </summary>
        public async Task<List<Player>> GetIncompletePlayersAsync()
        {
            return await _context.Players
                .Where(p => !p.IsDataComplete)
                .ToListAsync();
        }

        /// <summary>
        /// Get matches with incomplete data
        /// </summary>
        public async Task<List<Match>> GetIncompleteMatchesAsync()
        {
            return await _context.Matches
                .Where(m => !m.IsDataComplete)
                .ToListAsync();
        }

        /// <summary>
        /// Get incomplete countries
        /// </summary>
        public async Task<List<Country>> GetIncompleteCountriesAsync()
        {
            return await _context.Countries
                .Where(c => !c.IsDataComplete)
                .ToListAsync();
        }

        /// <summary>
        /// Get completion statistics
        /// </summary>
        public async Task<DataCompletionStats> GetCompletionStatsAsync()
        {
            return new DataCompletionStats
            {
                TotalSeasons = await _context.Seasons.CountAsync(),
                CompleteSeasons = await _context.Seasons.CountAsync(s => s.IsDataComplete),
                
                TotalCountries = await _context.Countries.CountAsync(),
                CompleteCountries = await _context.Countries.CountAsync(c => c.IsDataComplete),
                
                TotalLeagues = await _context.Leagues.CountAsync(),
                CompleteLeagues = await _context.Leagues.CountAsync(l => l.IsDataComplete),
                
                TotalTeams = await _context.Teams.CountAsync(),
                CompleteTeams = await _context.Teams.CountAsync(t => t.IsDataComplete),
                
                TotalPlayers = await _context.Players.CountAsync(),
                CompletePlayers = await _context.Players.CountAsync(p => p.IsDataComplete),
                
                TotalMatches = await _context.Matches.CountAsync(),
                CompleteMatches = await _context.Matches.CountAsync(m => m.IsDataComplete),
            };
        }

        /// <summary>
        /// Get all seasons
        /// </summary>
        public async Task<List<Season>> GetSeasonsAsync()
        {
            return await _context.Seasons
                .OrderByDescending(s => s.Year)
                .ToListAsync();
        }

        /// <summary>
        /// Get current season
        /// </summary>
        public async Task<Season?> GetCurrentSeasonAsync()
        {
            return await _context.Seasons
                .FirstOrDefaultAsync(s => s.IsCurrent);
        }

        /// <summary>
        /// Get all leagues
        /// </summary>
        public async Task<List<League>> GetLeaguesAsync()
        {
            return await _context.Leagues
                .OrderBy(l => l.Name)
                .ToListAsync();
        }

        /// <summary>
        /// Get league by ID
        /// </summary>
        public async Task<League?> GetLeagueAsync(int leagueId)
        {
            return await _context.Leagues
                .FirstOrDefaultAsync(l => l.Id == leagueId);
        }

        /// <summary>
        /// Get all teams
        /// </summary>
        public async Task<List<Team>> GetTeamsAsync()
        {
            return await _context.Teams.ToListAsync();
        }

        /// <summary>
        /// Get team with players
        /// </summary>
        public async Task<Team?> GetTeamWithPlayersAsync(int teamId)
        {
            return await _context.Teams
                .Include(t => t.Id)
                .FirstOrDefaultAsync(t => t.Id == teamId);
        }

        /// <summary>
        /// Get all matches with teams
        /// </summary>
        public async Task<List<Match>> GetMatchesAsync()
        {
            return await _context.Matches
                .Include(m => m.HomeTeam)
                .Include(m => m.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get matches for a season
        /// </summary>
        public async Task<List<Match>> GetMatchesBySeasonAsync(int season)
        {
            return await _context.Matches
                .Where(m => m.Season == season)
                .Include(m => m.HomeTeam)
                .Include(m => m.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get matches for a league
        /// </summary>
        public async Task<List<Match>> GetMatchesByLeagueAsync(int leagueId)
        {
            return await _context.Matches
                .Where(m => m.LeagueId == leagueId)
                .Include(m => m.HomeTeam)
                .Include(m => m.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get matches for a league and season
        /// </summary>
        public async Task<List<Match>> GetMatchesByLeagueAndSeasonAsync(int leagueId, int season)
        {
            return await _context.Matches
                .Where(m => m.LeagueId == leagueId && m.Season == season)
                .Include(m => m.HomeTeam)
                .Include(m => m.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get all countries
        /// </summary>
        public async Task<List<Country>> GetCountriesAsync()
        {
            return await _context.Countries
                .OrderBy(c => c.Name)
                .ToListAsync();
        }

        /// <summary>
        /// Get country by ID
        /// </summary>
        public async Task<Country?> GetCountryAsync(int countryId)
        {
            return await _context.Countries
                .FirstOrDefaultAsync(c => c.Id == countryId);
        }

        /// <summary>
        /// Get country by code
        /// </summary>
        public async Task<Country?> GetCountryByCodeAsync(string code)
        {
            return await _context.Countries
                .FirstOrDefaultAsync(c => c.Code == code);
        }

        /// <summary>
        /// Clear all data
        /// </summary>
        public async Task ClearAllDataAsync()
        {
            _context.Matches.RemoveRange(_context.Matches);
            _context.Players.RemoveRange(_context.Players);
            _context.Teams.RemoveRange(_context.Teams);
            _context.Leagues.RemoveRange(_context.Leagues);
            _context.Seasons.RemoveRange(_context.Seasons);
            _context.Countries.RemoveRange(_context.Countries);
            await _context.SaveChangesAsync();
        }
    }

    /// <summary>
    /// Statistics about data completion across all entities
    /// </summary>
    public class DataCompletionStats
    {
        public int TotalSeasons { get; set; }
        public int CompleteSeasons { get; set; }
        public double SeasonCompletionPercent => TotalSeasons > 0 ? (CompleteSeasons * 100.0 / TotalSeasons) : 0;

        public int TotalLeagues { get; set; }
        public int CompleteLeagues { get; set; }
        public double LeagueCompletionPercent => TotalLeagues > 0 ? (CompleteLeagues * 100.0 / TotalLeagues) : 0;

        public int TotalTeams { get; set; }
        public int CompleteTeams { get; set; }
        public double TeamCompletionPercent => TotalTeams > 0 ? (CompleteTeams * 100.0 / TotalTeams) : 0;

        public int TotalPlayers { get; set; }
        public int CompletePlayers { get; set; }
        public double PlayerCompletionPercent => TotalPlayers > 0 ? (CompletePlayers * 100.0 / TotalPlayers) : 0;

        public int TotalMatches { get; set; }
        public int CompleteMatches { get; set; }
        public double MatchCompletionPercent => TotalMatches > 0 ? (CompleteMatches * 100.0 / TotalMatches) : 0;

        public int TotalCountries { get; set; }
        public int CompleteCountries { get; set; }
        public double CountryCompletionPercent => TotalCountries > 0 ? (CompleteCountries * 100.0 / TotalCountries) : 0;

        public override string ToString()
        {
            return $@"
=== Data Completion Statistics ===
Seasons:  {CompleteSeasons}/{TotalSeasons} ({SeasonCompletionPercent:F1}%)
Leagues:  {CompleteLeagues}/{TotalLeagues} ({LeagueCompletionPercent:F1}%)
Teams:    {CompleteTeams}/{TotalTeams} ({TeamCompletionPercent:F1}%)
Players:  {CompletePlayers}/{TotalPlayers} ({PlayerCompletionPercent:F1}%)
Matches:  {CompleteMatches}/{TotalMatches} ({MatchCompletionPercent:F1}%)
Countries:{CompleteCountries}/{TotalCountries} ({CountryCompletionPercent:F1}%)";
        }
    }
}
