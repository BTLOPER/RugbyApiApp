using Microsoft.EntityFrameworkCore;
using RugbyApiApp.Data;
using RugbyApiApp.Models;

namespace RugbyApiApp.Services
{
    public class DataService
    {
        private readonly RugbyDbContext _context;

        public DataService(RugbyDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Add or update a season
        /// </summary>
        public async Task<Season> UpsertSeasonAsync(int seasonId, int? year, DateTime? startDate, DateTime? endDate, bool isCurrent)
        {
            var existingSeason = await _context.Seasons.FirstOrDefaultAsync(s => s.Id == seasonId);

            if (existingSeason != null)
            {
                existingSeason.Year = year ?? existingSeason.Year;
                existingSeason.StartDate = startDate ?? existingSeason.StartDate;
                existingSeason.EndDate = endDate ?? existingSeason.EndDate;
                existingSeason.IsCurrent = isCurrent;
                existingSeason.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingSeason = new Season
                {
                    Id = seasonId,
                    Year = year,
                    StartDate = startDate,
                    EndDate = endDate,
                    IsCurrent = isCurrent,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Seasons.Add(existingSeason);
            }

            await _context.SaveChangesAsync();
            return existingSeason;
        }

        /// <summary>
        /// Add or update a league
        /// </summary>
        public async Task<League> UpsertLeagueAsync(int leagueId, string? name, string? type, string? logo, string? countryName, string? countryCode, string? countryFlag)
        {
            var existingLeague = await _context.Leagues.FirstOrDefaultAsync(l => l.Id == leagueId);

            if (existingLeague != null)
            {
                existingLeague.Name = name ?? existingLeague.Name;
                existingLeague.Type = type ?? existingLeague.Type;
                existingLeague.Logo = logo ?? existingLeague.Logo;
                existingLeague.CountryName = countryName ?? existingLeague.CountryName;
                existingLeague.CountryCode = countryCode ?? existingLeague.CountryCode;
                existingLeague.CountryFlag = countryFlag ?? existingLeague.CountryFlag;
                existingLeague.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingLeague = new League
                {
                    Id = leagueId,
                    Name = name,
                    Type = type,
                    Logo = logo,
                    CountryName = countryName,
                    CountryCode = countryCode,
                    CountryFlag = countryFlag,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Leagues.Add(existingLeague);
            }

            await _context.SaveChangesAsync();
            return existingLeague;
        }

        /// <summary>
        /// Add or update a team
        /// </summary>
        public async Task<Team> UpsertTeamAsync(int teamId, string? name, string? code, string? flag, string? logo)
        {
            var existingTeam = await _context.Teams.FirstOrDefaultAsync(t => t.Id == teamId);

            if (existingTeam != null)
            {
                existingTeam.Name = name ?? existingTeam.Name;
                existingTeam.Code = code ?? existingTeam.Code;
                existingTeam.Flag = flag ?? existingTeam.Flag;
                existingTeam.Logo = logo ?? existingTeam.Logo;
                existingTeam.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingTeam = new Team
                {
                    Id = teamId,
                    Name = name,
                    Code = code,
                    Flag = flag,
                    Logo = logo,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Teams.Add(existingTeam);
            }

            await _context.SaveChangesAsync();
            return existingTeam;
        }

        /// <summary>
        /// Add or update a player
        /// </summary>
        public async Task<Player> UpsertPlayerAsync(int playerId, int teamId, string? name, string? position, int? number, string? photo, DateTime? dateOfBirth, string? nationality)
        {
            var existingPlayer = await _context.Players.FirstOrDefaultAsync(p => p.Id == playerId);

            if (existingPlayer != null)
            {
                existingPlayer.Name = name ?? existingPlayer.Name;
                existingPlayer.Position = position ?? existingPlayer.Position;
                existingPlayer.Number = number ?? existingPlayer.Number;
                existingPlayer.Photo = photo ?? existingPlayer.Photo;
                existingPlayer.DateOfBirth = dateOfBirth ?? existingPlayer.DateOfBirth;
                existingPlayer.Nationality = nationality ?? existingPlayer.Nationality;
                existingPlayer.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingPlayer = new Player
                {
                    Id = playerId,
                    TeamId = teamId,
                    Name = name,
                    Position = position,
                    Number = number,
                    Photo = photo,
                    DateOfBirth = dateOfBirth,
                    Nationality = nationality,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Players.Add(existingPlayer);
            }

            await _context.SaveChangesAsync();
            return existingPlayer;
        }

        /// <summary>
        /// Add or update a match
        /// </summary>
        public async Task<Match> UpsertMatchAsync(int matchId, int? leagueId, int? season, int homeTeamId, int awayTeamId, DateTime? date, string? status, string? venue, int? homeTeamScore, int? awayTeamScore)
        {
            var existingMatch = await _context.Matches.FirstOrDefaultAsync(m => m.Id == matchId);

            if (existingMatch != null)
            {
                existingMatch.LeagueId = leagueId ?? existingMatch.LeagueId;
                existingMatch.Season = season ?? existingMatch.Season;
                existingMatch.Date = date ?? existingMatch.Date;
                existingMatch.Status = status ?? existingMatch.Status;
                existingMatch.Venue = venue ?? existingMatch.Venue;
                existingMatch.HomeTeamScore = homeTeamScore ?? existingMatch.HomeTeamScore;
                existingMatch.AwayTeamScore = awayTeamScore ?? existingMatch.AwayTeamScore;
                existingMatch.UpdatedAt = DateTime.UtcNow;
            }
            else
            {
                existingMatch = new Match
                {
                    Id = matchId,
                    LeagueId = leagueId,
                    Season = season,
                    HomeTeamId = homeTeamId,
                    AwayTeamId = awayTeamId,
                    Date = date,
                    Status = status,
                    Venue = venue,
                    HomeTeamScore = homeTeamScore,
                    AwayTeamScore = awayTeamScore,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                _context.Matches.Add(existingMatch);
            }

            await _context.SaveChangesAsync();
            return existingMatch;
        }

        /// <summary>
        /// Get all seasons
        /// </summary>
        public async Task<List<Season>> GetSeasonsAsync()
        {
            return await _context.Seasons
                .OrderByDescending(s => s.Year)
                .ToListAsync();
        }

        /// <summary>
        /// Get current season
        /// </summary>
        public async Task<Season?> GetCurrentSeasonAsync()
        {
            return await _context.Seasons
                .FirstOrDefaultAsync(s => s.IsCurrent);
        }

        /// <summary>
        /// Get all leagues
        /// </summary>
        public async Task<List<League>> GetLeaguesAsync()
        {
            return await _context.Leagues
                .OrderBy(l => l.Name)
                .ToListAsync();
        }

        /// <summary>
        /// Get league by ID
        /// </summary>
        public async Task<League?> GetLeagueAsync(int leagueId)
        {
            return await _context.Leagues
                .FirstOrDefaultAsync(l => l.Id == leagueId);
        }

        /// <summary>
        /// Get all teams
        /// </summary>
        public async Task<List<Team>> GetTeamsAsync()
        {
            return await _context.Teams.ToListAsync();
        }

        /// <summary>
        /// Get team with players
        /// </summary>
        public async Task<Team?> GetTeamWithPlayersAsync(int teamId)
        {
            return await _context.Teams
                .Include(t => t.Id)
                .FirstOrDefaultAsync(t => t.Id == teamId);
        }

        /// <summary>
        /// Get all matches with teams
        /// </summary>
        public async Task<List<Match>> GetMatchesAsync()
        {
            return await _context.Matches
                .Include(m => m.HomeTeam)
                .Include(m => m.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get matches for a season
        /// </summary>
        public async Task<List<Match>> GetMatchesBySeasonAsync(int season)
        {
            return await _context.Matches
                .Where(m => m.Season == season)
                .Include(m => m.HomeTeam)
                .Include(m => m.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get matches for a league
        /// </summary>
        public async Task<List<Match>> GetMatchesByLeagueAsync(int leagueId)
        {
            return await _context.Matches
                .Where(m => m.LeagueId == leagueId)
                .Include(m => m.HomeTeam)
                .Include(m => m.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Get matches for a league and season
        /// </summary>
        public async Task<List<Match>> GetMatchesByLeagueAndSeasonAsync(int leagueId, int season)
        {
            return await _context.Matches
                .Where(m => m.LeagueId == leagueId && m.Season == season)
                .Include(m => m.HomeTeam)
                .Include(m => m.AwayTeam)
                .ToListAsync();
        }

        /// <summary>
        /// Clear all data
        /// </summary>
        public async Task ClearAllDataAsync()
        {
            _context.Matches.RemoveRange(_context.Matches);
            _context.Players.RemoveRange(_context.Players);
            _context.Teams.RemoveRange(_context.Teams);
            _context.Leagues.RemoveRange(_context.Leagues);
            _context.Seasons.RemoveRange(_context.Seasons);
            await _context.SaveChangesAsync();
        }
    }
}
