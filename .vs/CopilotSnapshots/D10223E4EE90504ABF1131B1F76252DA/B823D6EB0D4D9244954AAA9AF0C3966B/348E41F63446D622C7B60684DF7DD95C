using RugbyApiApp.Data;
using RugbyApiApp.Extensions;
using RugbyApiApp.Models;
using Microsoft.EntityFrameworkCore;

namespace RugbyApiApp.Examples
{
    /// <summary>
    /// Example queries and use cases for the Rugby API Application
    /// Uncomment any examples in Program.cs to use them
    /// </summary>
    public static class RugbyQueryExamples
    {
        /// <summary>
        /// Example: Get team statistics and standings
        /// </summary>
        public static void Example_TeamStandings()
        {
            using (var context = new RugbyDbContext())
            {
                var allMatches = context.Matches
                    .Include(m => m.HomeTeam)
                    .Include(m => m.AwayTeam)
                    .ToList();

                var teams = context.Teams.ToList();
                var standings = teams
                    .Select(t => t.GetStats(allMatches))
                    .OrderByDescending(s => s.Wins)
                    .ThenByDescending(s => s.PointDifference)
                    .ToList();

                Console.WriteLine("\n=== League Standings ===");
                foreach (var stat in standings)
                {
                    Console.WriteLine(stat);
                }
            }
        }

        /// <summary>
        /// Example: Find upcoming matches
        /// </summary>
        public static void Example_UpcomingMatches()
        {
            using (var context = new RugbyDbContext())
            {
                var upcomingMatches = context.Matches
                    .Include(m => m.HomeTeam)
                    .Include(m => m.AwayTeam)
                    .ToList()
                    .GetUpcomingMatches()
                    .Take(10);

                Console.WriteLine("\n=== Upcoming Matches ===");
                foreach (var match in upcomingMatches)
                {
                    var homeTeam = match.HomeTeam?.Name ?? "Unknown";
                    var awayTeam = match.AwayTeam?.Name ?? "Unknown";
                    Console.WriteLine($"{match.Date:yyyy-MM-dd HH:mm} | {homeTeam} vs {awayTeam}");
                }
            }
        }

        /// <summary>
        /// Example: Get recent match results
        /// </summary>
        public static void Example_RecentResults()
        {
            using (var context = new RugbyDbContext())
            {
                var recentMatches = context.Matches
                    .Include(m => m.HomeTeam)
                    .Include(m => m.AwayTeam)
                    .Where(m => m.Status == "FT" || m.Status == "AET")
                    .OrderByDescending(m => m.Date)
                    .Take(10)
                    .ToList();

                Console.WriteLine("\n=== Recent Results ===");
                foreach (var match in recentMatches)
                {
                    var homeTeam = match.HomeTeam?.Name ?? "Unknown";
                    var awayTeam = match.AwayTeam?.Name ?? "Unknown";
                    var score = match.FormatScore();
                    Console.WriteLine($"{homeTeam} {score} {awayTeam}");
                }
            }
        }

        /// <summary>
        /// Example: Get teams by league/season filter
        /// </summary>
        public static void Example_MatchesByLeague()
        {
            using (var context = new RugbyDbContext())
            {
                int leagueId = 1; // Premier League example
                var leagueMatches = context.Matches
                    .Include(m => m.HomeTeam)
                    .Include(m => m.AwayTeam)
                    .Where(m => m.LeagueId == leagueId)
                    .OrderByDescending(m => m.Date)
                    .Take(5)
                    .ToList();

                Console.WriteLine($"\n=== League {leagueId} Recent Matches ===");
                foreach (var match in leagueMatches)
                {
                    Console.WriteLine($"{match.Date:yyyy-MM-dd} | {match.HomeTeam?.Name} vs {match.AwayTeam?.Name}");
                }
            }
        }

        /// <summary>
        /// Example: Get team's head-to-head record
        /// </summary>
        public static void Example_HeadToHead(int team1Id, int team2Id)
        {
            using (var context = new RugbyDbContext())
            {
                var h2h = context.Matches
                    .Include(m => m.HomeTeam)
                    .Include(m => m.AwayTeam)
                    .Where(m => 
                        (m.HomeTeamId == team1Id && m.AwayTeamId == team2Id) ||
                        (m.HomeTeamId == team2Id && m.AwayTeamId == team1Id))
                    .OrderByDescending(m => m.Date)
                    .ToList();

                var team1 = context.Teams.Find(team1Id);
                var team2 = context.Teams.Find(team2Id);

                Console.WriteLine($"\n=== Head to Head: {team1?.Name} vs {team2?.Name} ===");
                Console.WriteLine($"Total Matches: {h2h.Count}");

                foreach (var match in h2h.Take(5))
                {
                    var score = match.FormatScore();
                    Console.WriteLine($"{match.Date:yyyy-MM-dd} | {match.HomeTeam?.Name} {score} {match.AwayTeam?.Name}");
                }
            }
        }

        /// <summary>
        /// Example: Get highest scoring matches
        /// </summary>
        public static void Example_HighestScoringMatches()
        {
            using (var context = new RugbyDbContext())
            {
                var topMatches = context.Matches
                    .Include(m => m.HomeTeam)
                    .Include(m => m.AwayTeam)
                    .AsEnumerable()
                    .Where(m => m.HomeTeamScore.HasValue && m.AwayTeamScore.HasValue)
                    .OrderByDescending(m => (m.HomeTeamScore ?? 0) + (m.AwayTeamScore ?? 0))
                    .Take(10)
                    .ToList();

                Console.WriteLine("\n=== Highest Scoring Matches ===");
                foreach (var match in topMatches)
                {
                    int totalScore = (match.HomeTeamScore ?? 0) + (match.AwayTeamScore ?? 0);
                    Console.WriteLine($"{match.HomeTeam?.Name} {match.FormatScore()} {match.AwayTeam?.Name} (Total: {totalScore})");
                }
            }
        }

        /// <summary>
        /// Example: Get teams that need data refresh
        /// </summary>
        public static void Example_StaleTeamData()
        {
            using (var context = new RugbyDbContext())
            {
                var staleTeams = context.Teams
                    .Where(t => (DateTime.UtcNow - t.UpdatedAt) > TimeSpan.FromHours(24))
                    .ToList();

                Console.WriteLine($"\n=== Teams needing refresh (older than 24 hours) ===");
                Console.WriteLine($"Count: {staleTeams.Count}");
                foreach (var team in staleTeams.Take(5))
                {
                    Console.WriteLine($"  - {team.Name} (updated {(DateTime.UtcNow - team.UpdatedAt).TotalHours:F1} hours ago)");
                }
            }
        }

        /// <summary>
        /// Example: Search teams by name
        /// </summary>
        public static void Example_SearchTeams(string searchTerm)
        {
            using (var context = new RugbyDbContext())
            {
                var results = context.Teams
                    .Where(t => t.Name != null && t.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                    .ToList();

                Console.WriteLine($"\n=== Search Results for '{searchTerm}' ===");
                foreach (var team in results)
                {
                    Console.WriteLine($"  - {team.Name} ({team.Code})");
                }
            }
        }

        /// <summary>
        /// Example: Export match data to CSV format
        /// </summary>
        public static void Example_ExportMatches(string filePath = "matches_export.csv")
        {
            using (var context = new RugbyDbContext())
            {
                var matches = context.Matches
                    .Include(m => m.HomeTeam)
                    .Include(m => m.AwayTeam)
                    .ToList();

                using (var writer = new StreamWriter(filePath))
                {
                    writer.WriteLine("Date,HomeTeam,AwayTeam,HomeScore,AwayScore,Status,Venue");
                    foreach (var match in matches)
                    {
                        writer.WriteLine($"{match.Date:yyyy-MM-dd},{match.HomeTeam?.Name},{match.AwayTeam?.Name},{match.HomeTeamScore},{match.AwayTeamScore},{match.Status},{match.Venue}");
                    }
                }

                Console.WriteLine($"\n? Exported {matches.Count} matches to {filePath}");
            }
        }

        /// <summary>
        /// Example: Get database statistics
        /// </summary>
        public static void Example_DatabaseStats()
        {
            using (var context = new RugbyDbContext())
            {
                int teamCount = context.Teams.Count();
                int playerCount = context.Players.Count();
                int matchCount = context.Matches.Count();
                int leagueCount = context.Leagues.Count();

                var oldestMatch = context.Matches.OrderBy(m => m.Date).FirstOrDefault();
                var newestMatch = context.Matches.OrderByDescending(m => m.Date).FirstOrDefault();

                Console.WriteLine("\n=== Database Statistics ===");
                Console.WriteLine($"Teams: {teamCount}");
                Console.WriteLine($"Players: {playerCount}");
                Console.WriteLine($"Matches: {matchCount}");
                Console.WriteLine($"Leagues: {leagueCount}");
                Console.WriteLine($"Date Range: {oldestMatch?.Date:yyyy-MM-dd} to {newestMatch?.Date:yyyy-MM-dd}");
            }
        }
    }
}
