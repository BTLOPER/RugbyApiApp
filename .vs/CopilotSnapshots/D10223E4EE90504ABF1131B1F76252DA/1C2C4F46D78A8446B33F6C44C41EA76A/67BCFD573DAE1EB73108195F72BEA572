using RugbyApiApp.Data;
using RugbyApiApp.Services;

namespace RugbyApiApp
{
    internal class Program
    {
        private static RugbyApiClient _apiClient = null!;
        private static DataService _dataService = null!;

        static async Task Main(string[] args)
        {
            Console.WriteLine("=== Rugby API Console Application ===\n");

            // Initialize database
            using (var context = new RugbyDbContext())
            {
                context.Database.EnsureCreated();
                Console.WriteLine("✓ Database initialized\n");
            }

            // Get API key from environment variable
            string? apiKey = Environment.GetEnvironmentVariable("RUGBY_API_KEY");
            if (string.IsNullOrEmpty(apiKey))
            {
                Console.WriteLine("ERROR: RUGBY_API_KEY environment variable not set.");
                Console.WriteLine("Please set your api-sports.io API key as an environment variable.");
                return;
            }

            _apiClient = new RugbyApiClient(apiKey);
            _dataService = new DataService(new RugbyDbContext());

            try
            {
                await ShowMainMenuAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ERROR: {ex.Message}");
                if (ex.InnerException != null)
                {
                    Console.WriteLine($"Details: {ex.InnerException.Message}");
                }
            }

            Console.WriteLine("\n=== Application finished ===");
        }

        static async Task ShowMainMenuAsync()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("╔════════════════════════════════════════════╗");
                Console.WriteLine("║   Rugby API Data Management System         ║");
                Console.WriteLine("╚════════════════════════════════════════════╝\n");

                // Show data statistics
                var stats = await _dataService.GetCompletionStatsAsync();
                Console.WriteLine("📊 Current Data Status:");
                Console.WriteLine($"  • Countries:  {stats.CompleteCountries:D3}/{stats.TotalCountries:D3} ({stats.CountryCompletionPercent:F1}%)");
                Console.WriteLine($"  • Seasons:    {stats.CompleteSeasons:D3}/{stats.TotalSeasons:D3} ({stats.SeasonCompletionPercent:F1}%)");
                Console.WriteLine($"  • Leagues:    {stats.CompleteLeagues:D3}/{stats.TotalLeagues:D3} ({stats.LeagueCompletionPercent:F1}%)");
                Console.WriteLine($"  • Teams:      {stats.CompleteTeams:D3}/{stats.TotalTeams:D3} ({stats.TeamCompletionPercent:F1}%)");
                Console.WriteLine($"  • Players:    {stats.CompletePlayers:D3}/{stats.TotalPlayers:D3} ({stats.PlayerCompletionPercent:F1}%)");
                Console.WriteLine($"  • Matches:    {stats.CompleteMatches:D3}/{stats.TotalMatches:D3} ({stats.MatchCompletionPercent:F1}%)\n");

                Console.WriteLine("📋 Main Menu:");
                Console.WriteLine("  [1] Browse & Fetch Countries");
                Console.WriteLine("  [2] Browse & Fetch Seasons");
                Console.WriteLine("  [3] Browse & Fetch Leagues");
                Console.WriteLine("  [4] Browse & Fetch Teams");
                Console.WriteLine("  [5] Browse & Fetch Matches");
                Console.WriteLine("  [6] View All Stored Data");
                Console.WriteLine("  [7] Auto-Fetch All Incomplete Data");
                Console.WriteLine("  [8] Clear All Data");
                Console.WriteLine("  [0] Exit\n");

                Console.Write("Enter your choice (0-8): ");
                string? choice = Console.ReadLine();

                switch (choice)
                {
                    case "1":
                        await ShowCountriesMenuAsync();
                        break;
                    case "2":
                        await ShowSeasonsMenuAsync();
                        break;
                    case "3":
                        await ShowLeaguesMenuAsync();
                        break;
                    case "4":
                        await ShowTeamsMenuAsync();
                        break;
                    case "5":
                        await ShowMatchesMenuAsync();
                        break;
                    case "6":
                        await DisplayStoredDataAsync();
                        WaitForKeyPress();
                        break;
                    case "7":
                        await AutoFetchAllIncompleteAsync();
                        WaitForKeyPress();
                        break;
                    case "8":
                        await ClearAllDataAsync();
                        WaitForKeyPress();
                        break;
                    case "0":
                        return;
                    default:
                        Console.WriteLine("Invalid choice. Press any key to continue...");
                        Console.ReadKey();
                        break;
                }
            }
        }

        static async Task ShowCountriesMenuAsync()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("╔════════════════════════════════════════════╗");
                Console.WriteLine("║         Countries Management               ║");
                Console.WriteLine("╚════════════════════════════════════════════╝\n");

                var countries = await _dataService.GetCountriesAsync();
                var incompleteCountries = await _dataService.GetIncompleteCountriesAsync();

                Console.WriteLine($"📍 Countries: {countries.Count} total");
                Console.WriteLine($"   ✓ Complete: {countries.Count(c => c.IsDataComplete)}");
                Console.WriteLine($"   ⚠ Incomplete: {incompleteCountries.Count}\n");

                if (countries.Any())
                {
                    Console.WriteLine("📋 Countries in Database:");
                    int index = 1;
                    foreach (var country in countries.Take(10))
                    {
                        var status = country.IsDataComplete ? "✓" : "⚠";
                        Console.WriteLine($"  {status} {country.Name} ({country.Code})");
                        index++;
                    }
                    if (countries.Count > 10)
                        Console.WriteLine($"  ... and {countries.Count - 10} more");
                }

                Console.WriteLine("\n📋 Menu:");
                Console.WriteLine("  [1] Fetch Countries from API");
                Console.WriteLine("  [2] View All Countries (paginated)");
                Console.WriteLine("  [0] Back to Main Menu\n");

                Console.Write("Enter your choice (0-2): ");
                string? choice = Console.ReadLine();

                switch (choice)
                {
                    case "1":
                        await FetchAndStoreCountriesAsync();
                        WaitForKeyPress();
                        break;
                    case "2":
                        await ViewAllCountriesAsync();
                        break;
                    case "0":
                        return;
                    default:
                        Console.WriteLine("Invalid choice. Press any key to continue...");
                        Console.ReadKey();
                        break;
                }
            }
        }

        static async Task ShowSeasonsMenuAsync()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("╔════════════════════════════════════════════╗");
                Console.WriteLine("║         Seasons Management                 ║");
                Console.WriteLine("╚════════════════════════════════════════════╝\n");

                var seasons = await _dataService.GetSeasonsAsync();
                var incompleteSeasons = await _dataService.GetIncompleteSeasonAsync();

                Console.WriteLine($"📅 Seasons: {seasons.Count} total");
                Console.WriteLine($"   ✓ Complete: {seasons.Count(s => s.IsDataComplete)}");
                Console.WriteLine($"   ⚠ Incomplete: {incompleteSeasons.Count}\n");

                if (seasons.Any())
                {
                    Console.WriteLine("📋 Seasons in Database:");
                    foreach (var season in seasons.Take(10))
                    {
                        var status = season.IsDataComplete ? "✓" : "⚠";
                        var current = season.IsCurrent ? " (CURRENT)" : "";
                        Console.WriteLine($"  {status} Season {season.Year}{current}");
                    }
                    if (seasons.Count > 10)
                        Console.WriteLine($"  ... and {seasons.Count - 10} more");
                }

                Console.WriteLine("\n📋 Menu:");
                Console.WriteLine("  [1] Fetch Seasons from API");
                Console.WriteLine("  [2] View All Seasons");
                Console.WriteLine("  [0] Back to Main Menu\n");

                Console.Write("Enter your choice (0-2): ");
                string? choice = Console.ReadLine();

                switch (choice)
                {
                    case "1":
                        await FetchAndStoreSeasonAsync();
                        WaitForKeyPress();
                        break;
                    case "2":
                        await ViewAllSeasonsAsync();
                        break;
                    case "0":
                        return;
                    default:
                        Console.WriteLine("Invalid choice. Press any key to continue...");
                        Console.ReadKey();
                        break;
                }
            }
        }

        static async Task ShowLeaguesMenuAsync()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("╔════════════════════════════════════════════╗");
                Console.WriteLine("║         Leagues Management                 ║");
                Console.WriteLine("╚════════════════════════════════════════════╝\n");

                var leagues = await _dataService.GetLeaguesAsync();
                var incompleteLeagues = await _dataService.GetIncompleteLeaguesAsync();

                Console.WriteLine($"🏆 Leagues: {leagues.Count} total");
                Console.WriteLine($"   ✓ Complete: {leagues.Count(l => l.IsDataComplete)}");
                Console.WriteLine($"   ⚠ Incomplete: {incompleteLeagues.Count}\n");

                if (leagues.Any())
                {
                    Console.WriteLine("📋 Leagues in Database:");
                    foreach (var league in leagues.Take(10))
                    {
                        var status = league.IsDataComplete ? "✓" : "⚠";
                        Console.WriteLine($"  {status} {league.Name} ({league.CountryCode})");
                    }
                    if (leagues.Count > 10)
                        Console.WriteLine($"  ... and {leagues.Count - 10} more");
                }

                Console.WriteLine("\n📋 Menu:");
                Console.WriteLine("  [1] Fetch Leagues from API");
                Console.WriteLine("  [2] View All Leagues (paginated)");
                Console.WriteLine("  [0] Back to Main Menu\n");

                Console.Write("Enter your choice (0-2): ");
                string? choice = Console.ReadLine();

                switch (choice)
                {
                    case "1":
                        await FetchAndStoreLeaguesAsync();
                        WaitForKeyPress();
                        break;
                    case "2":
                        await ViewAllLeaguesAsync();
                        break;
                    case "0":
                        return;
                    default:
                        Console.WriteLine("Invalid choice. Press any key to continue...");
                        Console.ReadKey();
                        break;
                }
            }
        }

        static async Task ShowTeamsMenuAsync()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("╔════════════════════════════════════════════╗");
                Console.WriteLine("║         Teams Management                   ║");
                Console.WriteLine("╚════════════════════════════════════════════╝\n");

                var teams = await _dataService.GetTeamsAsync();
                var incompleteTeams = await _dataService.GetIncompleteTeamsAsync();

                Console.WriteLine($"🏉 Teams: {teams.Count} total");
                Console.WriteLine($"   ✓ Complete (w/ players): {teams.Count(t => t.IsDataComplete)}");
                Console.WriteLine($"   ⚠ Incomplete (need players): {incompleteTeams.Count}\n");

                if (incompleteTeams.Any())
                {
                    Console.WriteLine("⚠️ Teams Needing Player Data:");
                    foreach (var team in incompleteTeams.Take(10))
                    {
                        Console.WriteLine($"  • {team.Name} ({team.Code})");
                    }
                    if (incompleteTeams.Count > 10)
                        Console.WriteLine($"  ... and {incompleteTeams.Count - 10} more");
                    Console.WriteLine();
                }

                if (teams.Any())
                {
                    Console.WriteLine("📋 Recent Teams:");
                    foreach (var team in teams.Take(5))
                    {
                        var status = team.IsDataComplete ? "✓" : "⚠";
                        Console.WriteLine($"  {status} {team.Name} ({team.Code})");
                    }
                    if (teams.Count > 5)
                        Console.WriteLine($"  ... and {teams.Count - 5} more");
                }

                Console.WriteLine("\n📋 Menu:");
                Console.WriteLine("  [1] Fetch Teams & Matches for Season");
                Console.WriteLine("  [2] Fetch Players for Incomplete Teams");
                Console.WriteLine("  [3] View All Teams (paginated)");
                Console.WriteLine("  [0] Back to Main Menu\n");

                Console.Write("Enter your choice (0-3): ");
                string? choice = Console.ReadLine();

                switch (choice)
                {
                    case "1":
                        await FetchTeamsAndMatchesInteractiveAsync();
                        WaitForKeyPress();
                        break;
                    case "2":
                        await FetchPlayersForIncompleteTeamsAsync();
                        WaitForKeyPress();
                        break;
                    case "3":
                        await ViewAllTeamsAsync();
                        break;
                    case "0":
                        return;
                    default:
                        Console.WriteLine("Invalid choice. Press any key to continue...");
                        Console.ReadKey();
                        break;
                }
            }
        }

        static async Task ShowMatchesMenuAsync()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("╔════════════════════════════════════════════╗");
                Console.WriteLine("║         Matches Management                 ║");
                Console.WriteLine("╚════════════════════════════════════════════╝\n");

                var matches = await _dataService.GetMatchesAsync();
                var incompleteMatches = await _dataService.GetIncompleteMatchesAsync();

                Console.WriteLine($"🎮 Matches: {matches.Count} total");
                Console.WriteLine($"   ✓ Complete: {matches.Count(m => m.IsDataComplete)}");
                Console.WriteLine($"   ⚠ Incomplete: {incompleteMatches.Count}\n");

                if (matches.Any())
                {
                    Console.WriteLine("📋 Recent Matches:");
                    foreach (var match in matches.TakeLast(10))
                    {
                        var homeTeam = match.HomeTeam?.Name ?? "Unknown";
                        var awayTeam = match.AwayTeam?.Name ?? "Unknown";
                        var score = match.HomeTeamScore.HasValue && match.AwayTeamScore.HasValue
                            ? $" [{match.HomeTeamScore}-{match.AwayTeamScore}]"
                            : "";
                        Console.WriteLine($"  • {homeTeam} vs {awayTeam} ({match.Status}){score}");
                    }
                }

                Console.WriteLine("\n📋 Menu:");
                Console.WriteLine("  [1] View All Matches (paginated)");
                Console.WriteLine("  [0] Back to Main Menu\n");

                Console.Write("Enter your choice (0-1): ");
                string? choice = Console.ReadLine();

                switch (choice)
                {
                    case "1":
                        await ViewAllMatchesAsync();
                        break;
                    case "0":
                        return;
                    default:
                        Console.WriteLine("Invalid choice. Press any key to continue...");
                        Console.ReadKey();
                        break;
                }
            }
        }

        static async Task FetchTeamsAndMatchesInteractiveAsync()
        {
            Console.Clear();
            Console.WriteLine("╔════════════════════════════════════════════╗");
            Console.WriteLine("║    Fetch Teams & Matches for Season        ║");
            Console.WriteLine("╚════════════════════════════════════════════╝\n");

            var seasons = await _dataService.GetSeasonsAsync();
            if (!seasons.Any())
            {
                Console.WriteLine("⚠ No seasons in database. Fetch seasons first.\n");
                return;
            }

            Console.WriteLine("Available Seasons:");
            var seasonList = seasons.OrderByDescending(s => s.Year).ToList();
            for (int i = 0; i < seasonList.Count; i++)
            {
                var season = seasonList[i];
                var current = season.IsCurrent ? " (CURRENT)" : "";
                Console.WriteLine($"  [{i + 1}] Season {season.Year}{current}");
            }

            Console.Write("\nSelect season (or 0 to cancel): ");
            if (!int.TryParse(Console.ReadLine(), out int seasonChoice) || seasonChoice == 0)
                return;

            if (seasonChoice < 1 || seasonChoice > seasonList.Count)
            {
                Console.WriteLine("Invalid choice.");
                return;
            }

            var selectedSeason = seasonList[seasonChoice - 1];
            var leagues = await _dataService.GetLeaguesAsync();
            
            if (!leagues.Any())
            {
                Console.WriteLine("⚠ No leagues in database. Fetch leagues first.\n");
                return;
            }

            await FetchAndStoreTeamsAndMatchesAsync(_apiClient, _dataService, selectedSeason.Year!.Value, leagues);
        }

        static async Task FetchPlayersForIncompleteTeamsAsync()
        {
            Console.Clear();
            Console.WriteLine("╔════════════════════════════════════════════╗");
            Console.WriteLine("║    Fetch Players for Incomplete Teams      ║");
            Console.WriteLine("╚════════════════════════════════════════════╝\n");

            await FetchAndStorePlayersAsync(_apiClient, _dataService);
        }

        static async Task ViewAllCountriesAsync()
        {
            Console.Clear();
            var countries = await _dataService.GetCountriesAsync();
            int pageSize = 10;
            int totalPages = (countries.Count + pageSize - 1) / pageSize;
            int currentPage = 0;

            while (true)
            {
                Console.Clear();
                Console.WriteLine($"╔════════════════════════════════════════════╗");
                Console.WriteLine($"║       Countries (Page {currentPage + 1}/{totalPages})                     ║");
                Console.WriteLine($"╚════════════════════════════════════════════╝\n");

                var pageItems = countries.Skip(currentPage * pageSize).Take(pageSize).ToList();
                foreach (var country in pageItems)
                {
                    var status = country.IsDataComplete ? "✓" : "⚠";
                    Console.WriteLine($"  {status} {country.Name,-30} ({country.Code})");
                }

                Console.WriteLine($"\nShowing {pageItems.Count} of {countries.Count} countries");
                Console.WriteLine("\n[N] Next | [P] Previous | [0] Back");
                Console.Write("Enter choice: ");
                string? choice = Console.ReadLine()?.ToUpper();

                if (choice == "0") break;
                if (choice == "N" && currentPage < totalPages - 1) currentPage++;
                if (choice == "P" && currentPage > 0) currentPage--;
            }
        }

        static async Task ViewAllSeasonsAsync()
        {
            Console.Clear();
            var seasons = await _dataService.GetSeasonsAsync();

            Console.WriteLine("╔════════════════════════════════════════════╗");
            Console.WriteLine("║          All Seasons                       ║");
            Console.WriteLine("╚════════════════════════════════════════════╝\n");

            foreach (var season in seasons)
            {
                var status = season.IsDataComplete ? "✓" : "⚠";
                var current = season.IsCurrent ? " (CURRENT)" : "";
                var dates = season.StartDate.HasValue && season.EndDate.HasValue
                    ? $" {season.StartDate:yyyy-MM-dd} to {season.EndDate:yyyy-MM-dd}"
                    : "";
                Console.WriteLine($"  {status} Season {season.Year}{current}{dates}");
            }

            Console.WriteLine("\nPress any key to continue...");
            Console.ReadKey();
        }

        static async Task ViewAllLeaguesAsync()
        {
            Console.Clear();
            var leagues = await _dataService.GetLeaguesAsync();
            int pageSize = 10;
            int totalPages = (leagues.Count + pageSize - 1) / pageSize;
            int currentPage = 0;

            while (true)
            {
                Console.Clear();
                Console.WriteLine($"╔════════════════════════════════════════════╗");
                Console.WriteLine($"║       Leagues (Page {currentPage + 1}/{totalPages})                      ║");
                Console.WriteLine($"╚════════════════════════════════════════════╝\n");

                var pageItems = leagues.Skip(currentPage * pageSize).Take(pageSize).ToList();
                foreach (var league in pageItems)
                {
                    var status = league.IsDataComplete ? "✓" : "⚠";
                    Console.WriteLine($"  {status} {league.Name,-30} ({league.CountryCode})");
                }

                Console.WriteLine($"\nShowing {pageItems.Count} of {leagues.Count} leagues");
                Console.WriteLine("\n[N] Next | [P] Previous | [0] Back");
                Console.Write("Enter choice: ");
                string? choice = Console.ReadLine()?.ToUpper();

                if (choice == "0") break;
                if (choice == "N" && currentPage < totalPages - 1) currentPage++;
                if (choice == "P" && currentPage > 0) currentPage--;
            }
        }

        static async Task ViewAllTeamsAsync()
        {
            Console.Clear();
            var teams = await _dataService.GetTeamsAsync();
            int pageSize = 10;
            int totalPages = (teams.Count + pageSize - 1) / pageSize;
            int currentPage = 0;

            while (true)
            {
                Console.Clear();
                Console.WriteLine($"╔════════════════════════════════════════════╗");
                Console.WriteLine($"║       Teams (Page {currentPage + 1}/{totalPages})                        ║");
                Console.WriteLine($"╚════════════════════════════════════════════╝\n");

                var pageItems = teams.Skip(currentPage * pageSize).Take(pageSize).ToList();
                foreach (var team in pageItems)
                {
                    var status = team.IsDataComplete ? "✓" : "⚠";
                    Console.WriteLine($"  {status} {team.Name,-25} ({team.Code})");
                }

                Console.WriteLine($"\nShowing {pageItems.Count} of {teams.Count} teams");
                Console.WriteLine("\n[N] Next | [P] Previous | [0] Back");
                Console.Write("Enter choice: ");
                string? choice = Console.ReadLine()?.ToUpper();

                if (choice == "0") break;
                if (choice == "N" && currentPage < totalPages - 1) currentPage++;
                if (choice == "P" && currentPage > 0) currentPage--;
            }
        }

        static async Task ViewAllMatchesAsync()
        {
            Console.Clear();
            var matches = await _dataService.GetMatchesAsync();
            int pageSize = 10;
            int totalPages = (matches.Count + pageSize - 1) / pageSize;
            int currentPage = 0;

            while (true)
            {
                Console.Clear();
                Console.WriteLine($"╔════════════════════════════════════════════╗");
                Console.WriteLine($"║       Matches (Page {currentPage + 1}/{totalPages})                      ║");
                Console.WriteLine($"╚════════════════════════════════════════════╝\n");

                var pageItems = matches.Skip(currentPage * pageSize).Take(pageSize).ToList();
                foreach (var match in pageItems)
                {
                    var homeTeam = match.HomeTeam?.Name ?? "Unknown";
                    var awayTeam = match.AwayTeam?.Name ?? "Unknown";
                    var score = match.HomeTeamScore.HasValue && match.AwayTeamScore.HasValue
                        ? $" [{match.HomeTeamScore}-{match.AwayTeamScore}]"
                        : "";
                    Console.WriteLine($"  {homeTeam,-20} vs {awayTeam,-20} ({match.Status}){score}");
                }

                Console.WriteLine($"\nShowing {pageItems.Count} of {matches.Count} matches");
                Console.WriteLine("\n[N] Next | [P] Previous | [0] Back");
                Console.Write("Enter choice: ");
                string? choice = Console.ReadLine()?.ToUpper();

                if (choice == "0") break;
                if (choice == "N" && currentPage < totalPages - 1) currentPage++;
                if (choice == "P" && currentPage > 0) currentPage--;
            }
        }

        static async Task FetchAndStoreCountriesAsync()
        {
            Console.WriteLine("Fetching countries from API...");
            try
            {
                // Check for incomplete countries
                var incompleteCountries = await _dataService.GetIncompleteCountriesAsync();
                if (incompleteCountries.Count > 0)
                {
                    Console.WriteLine($"Found {incompleteCountries.Count} incomplete countries, skipping API call\n");
                    return;
                }

                var countries = await _apiClient.GetCountriesAsync(page: 1);

                if (countries != null && countries.Count > 0)
                {
                    Console.WriteLine($"Retrieved {countries.Count} countries");

                    foreach (var countryResponse in countries)
                    {
                        if (countryResponse.Id.HasValue && countryResponse.Name != null)
                        {
                            var cdnFlag = RugbyApiClient.ConvertToCdnUrl(countryResponse.Flag);

                            await _dataService.UpsertCountryAsync(
                                countryResponse.Id.Value,
                                countryResponse.Name,
                                countryResponse.Code,
                                cdnFlag
                            );
                        }
                    }

                    Console.WriteLine($"✓ Stored {countries.Count} countries in database\n");
                }
                else
                {
                    Console.WriteLine("⚠ No countries retrieved from API\n");
                }
            }
            catch (HttpRequestException ex)
            {
                Console.WriteLine($"⚠ Error fetching countries: {ex.Message}\n");
            }
        }

        static async Task FetchAndStoreSeasonAsync()
        {
            Console.WriteLine("Fetching seasons from API...");
            try
            {
                // Check for incomplete seasons
                var incompleteSessions = await _dataService.GetIncompleteSeasonAsync();
                if (incompleteSessions.Count > 0)
                {
                    Console.WriteLine($"Found {incompleteSessions.Count} incomplete seasons, skipping API call");
                    return;
                }

                var seasons = await _apiClient.GetSeasonsAsync();

                if (seasons != null && seasons.Count > 0)
                {
                    Console.WriteLine($"Retrieved {seasons.Count} seasons");

                    foreach (var seasonResponse in seasons)
                    {
                        if (seasonResponse.Id.HasValue && seasonResponse.Year.HasValue)
                        {
                            DateTime? startDate = null;
                            DateTime? endDate = null;

                            if (DateTime.TryParse(seasonResponse.Start, out var start))
                                startDate = start;
                            if (DateTime.TryParse(seasonResponse.End, out var end))
                                endDate = end;

                            await _dataService.UpsertSeasonAsync(
                                seasonResponse.Id.Value,
                                seasonResponse.Year.Value,
                                startDate,
                                endDate,
                                seasonResponse.Current ?? false
                            );
                        }
                    }

                    Console.WriteLine($"✓ Stored {seasons.Count} seasons in database\n");
                }
                else
                {
                    Console.WriteLine("⚠ No seasons retrieved from API\n");
                }
            }
            catch (HttpRequestException ex)
            {
                Console.WriteLine($"⚠ Error fetching seasons: {ex.Message}\n");
            }
        }

        static async Task FetchAndStoreLeaguesAsync()
        {
            Console.WriteLine("Fetching leagues from API...");
            try
            {
                // Check for incomplete leagues
                var incompleteLeagues = await _dataService.GetIncompleteLeaguesAsync();
                if (incompleteLeagues.Count > 0)
                {
                    Console.WriteLine($"Found {incompleteLeagues.Count} incomplete leagues, skipping API call\n");
                    return;
                }

                var leagues = await _apiClient.GetLeaguesAsync(page: 1);

                if (leagues != null && leagues.Count > 0)
                {
                    Console.WriteLine($"Retrieved {leagues.Count} leagues");

                    foreach (var leagueResponse in leagues)
                    {
                        if (leagueResponse.Id.HasValue && leagueResponse.Name != null)
                        {
                            var cdnLogo = RugbyApiClient.ConvertToCdnUrl(leagueResponse.Logo);
                            var cdnFlag = RugbyApiClient.ConvertToCdnUrl(leagueResponse.Country?.Flag);

                            await _dataService.UpsertLeagueAsync(
                                leagueResponse.Id.Value,
                                leagueResponse.Name,
                                leagueResponse.Type,
                                cdnLogo,
                                leagueResponse.Country?.Name,
                                leagueResponse.Country?.Code,
                                cdnFlag
                            );
                        }
                    }

                    Console.WriteLine($"✓ Stored {leagues.Count} leagues in database\n");
                }
                else
                {
                    Console.WriteLine("⚠ No leagues retrieved from API\n");
                }
            }
            catch (HttpRequestException ex)
            {
                Console.WriteLine($"⚠ Error fetching leagues: {ex.Message}\n");
            }
        }

        static async Task FetchAndStoreTeamsAndMatchesAsync(RugbyApiClient apiClient, DataService dataService, int season, List<Models.League> leagues)
        {
            Console.WriteLine($"Fetching teams and matches for season {season}...\n");

            // Get incomplete teams to determine which leagues need processing
            var incompleteTeams = await dataService.GetIncompleteTeamsAsync();
            var leaguesNeedingUpdate = incompleteTeams.Select(t => t.Id).Distinct().ToHashSet();

            foreach (var league in leagues.Take(3)) // Limit to first 3 leagues to avoid rate limiting
            {
                try
                {
                    // Check if any teams in this league need updating
                    var leagueTeams = await dataService.GetTeamsAsync();
                    var needsUpdate = leagueTeams.Any(t => !t.IsDataComplete);

                    if (!needsUpdate)
                    {
                        Console.WriteLine($"League {league.Name}: All data complete, skipping");
                        continue;
                    }

                    Console.WriteLine($"Processing league: {league.Name}");

                    // Fetch teams for this league and season
                    var teams = await apiClient.GetTeamsByLeagueAsync(league.Id, season, page: 1);
                    if (teams != null && teams.Count > 0)
                    {
                        Console.WriteLine($"  Retrieved {teams.Count} teams");

                        foreach (var teamResponse in teams)
                        {
                            if (teamResponse.Id.HasValue && teamResponse.Name != null)
                            {
                                var cdnLogo = RugbyApiClient.ConvertToCdnUrl(teamResponse.Logo);
                                var cdnFlag = RugbyApiClient.ConvertToCdnUrl(teamResponse.Flag);

                                await dataService.UpsertTeamAsync(
                                    teamResponse.Id.Value,
                                    teamResponse.Name,
                                    teamResponse.Code,
                                    cdnFlag,
                                    cdnLogo
                                );
                            }
                        }
                    }

                    // Fetch matches for this league and season
                    var matches = await apiClient.GetMatchesByLeagueAndSeasonAsync(league.Id, season, page: 1);
                    if (matches != null && matches.Count > 0)
                    {
                        Console.WriteLine($"  Retrieved {matches.Count} matches");

                        foreach (var matchResponse in matches)
                        {
                            if (matchResponse.Id.HasValue &&
                                matchResponse.Home?.Id.HasValue == true &&
                                matchResponse.Away?.Id.HasValue == true)
                            {
                                await dataService.UpsertMatchAsync(
                                    matchResponse.Id.Value,
                                    matchResponse.LeagueId,
                                    matchResponse.Season,
                                    matchResponse.Home.Id.Value,
                                    matchResponse.Away.Id.Value,
                                    matchResponse.Date,
                                    matchResponse.Status,
                                    matchResponse.Venue,
                                    matchResponse.Score?.Home,
                                    matchResponse.Score?.Away
                                );
                            }
                        }
                    }

                    Console.WriteLine();
                }
                catch (HttpRequestException ex)
                {
                    Console.WriteLine($"  ⚠ Error processing league {league.Name}: {ex.Message}\n");
                }
            }
        }

        static async Task FetchAndStorePlayersAsync(RugbyApiClient apiClient, DataService dataService)
        {
            Console.WriteLine("Fetching players for incomplete teams...\n");

            var incompleteTeams = await dataService.GetIncompleteTeamsAsync();
            if (incompleteTeams.Count == 0)
            {
                Console.WriteLine("All teams have complete player data, skipping API calls\n");
                return;
            }

            Console.WriteLine($"Found {incompleteTeams.Count} teams needing player data");

            foreach (var team in incompleteTeams.Take(5)) // Limit to avoid rate limiting
            {
                try
                {
                    Console.WriteLine($"Fetching players for {team.Name}...");

                    var players = await apiClient.GetTeamPlayersAsync(team.Id, page: 1);
                    if (players != null && players.Count > 0)
                    {
                        Console.WriteLine($"  Retrieved {players.Count} players");

                        foreach (var playerResponse in players)
                        {
                            if (playerResponse.Id.HasValue && playerResponse.Name != null)
                            {
                                var cdnPhoto = RugbyApiClient.ConvertToCdnUrl(playerResponse.Photo);

                                DateTime? dateOfBirth = null;
                                if (playerResponse.DateOfBirth.HasValue)
                                {
                                    dateOfBirth = playerResponse.DateOfBirth.Value.ToDateTime(TimeOnly.MinValue);
                                }

                                await dataService.UpsertPlayerAsync(
                                    playerResponse.Id.Value,
                                    team.Id,
                                    playerResponse.Name,
                                    playerResponse.Position,
                                    playerResponse.Number,
                                    cdnPhoto,
                                    dateOfBirth,
                                    playerResponse.Nationality
                                );
                            }
                        }

                        // Mark team as complete after all players fetched
                        await dataService.MarkTeamDataCompleteAsync(team.Id);
                    }
                    else
                    {
                        // Mark team as complete even if no players (in case API returned empty)
                        await dataService.MarkTeamDataCompleteAsync(team.Id);
                    }

                    Console.WriteLine();
                }
                catch (HttpRequestException ex)
                {
                    Console.WriteLine($"  ⚠ Error fetching players for {team.Name}: {ex.Message}\n");
                }
            }
        }

        static async Task DisplayStoredDataAsync(DataService dataService)
        {
            Console.WriteLine("=== Stored Data ===\n");

            var seasons = await dataService.GetSeasonsAsync();
            Console.WriteLine($"Seasons in database: {seasons.Count}");
            foreach (var season in seasons.Take(3))
            {
                Console.WriteLine($"  - Season {season.Year} ({(season.IsCurrent ? "Current" : "Past")})");
            }

            var countries = await dataService.GetCountriesAsync();
            Console.WriteLine($"\nCountries in database: {countries.Count}");
            foreach (var country in countries.Take(5))
            {
                var completeness = country.IsDataComplete ? "✓" : "⚠";
                Console.WriteLine($"  {completeness} {country.Name} ({country.Code})");
            }

            var leagues = await dataService.GetLeaguesAsync();
            Console.WriteLine($"\nLeagues in database: {leagues.Count}");
            foreach (var league in leagues.Take(5))
            {
                Console.WriteLine($"  - {league.Name} ({league.CountryCode})");
            }

            var teams = await dataService.GetTeamsAsync();
            Console.WriteLine($"\nTeams in database: {teams.Count}");
            foreach (var team in teams.Take(5))
            {
                var completeness = team.IsDataComplete ? "✓" : "⚠";
                Console.WriteLine($"  {completeness} {team.Name} ({team.Code})");
            }

            var matches = await dataService.GetMatchesAsync();
            Console.WriteLine($"\nMatches in database: {matches.Count}");
            foreach (var match in matches.Take(5))
            {
                var homeTeam = match.HomeTeam?.Name ?? "Unknown";
                var awayTeam = match.AwayTeam?.Name ?? "Unknown";
                Console.WriteLine($"  - {homeTeam} vs {awayTeam} ({match.Status})");
                if (match.HomeTeamScore.HasValue && match.AwayTeamScore.HasValue)
                {
                    Console.WriteLine($"    Score: {match.HomeTeamScore} - {match.AwayTeamScore}");
                }
            }

            // Display completion statistics
            var stats = await dataService.GetCompletionStatsAsync();
            Console.WriteLine(stats);
        }

        static async Task AutoFetchAllIncompleteAsync()
        {
            Console.Clear();
            Console.WriteLine("╔════════════════════════════════════════════╗");
            Console.WriteLine("║    Auto-Fetching All Incomplete Data       ║");
            Console.WriteLine("╚════════════════════════════════════════════╝\n");

            // Fetch countries
            Console.WriteLine("→ Fetching Countries...");
            await FetchAndStoreCountriesAsync();

            // Fetch seasons
            Console.WriteLine("→ Fetching Seasons...");
            await FetchAndStoreSeasonAsync();

            // Fetch leagues
            Console.WriteLine("→ Fetching Leagues...");
            await FetchAndStoreLeaguesAsync();

            // Get current season
            var currentSeason = await _dataService.GetCurrentSeasonAsync();
            if (currentSeason == null)
            {
                var seasons = await _dataService.GetSeasonsAsync();
                currentSeason = seasons.FirstOrDefault();
            }

            // Fetch teams and matches
            if (currentSeason != null && currentSeason.Year.HasValue)
            {
                var leagues = await _dataService.GetLeaguesAsync();
                if (leagues.Any())
                {
                    Console.WriteLine("→ Fetching Teams & Matches...");
                    await FetchAndStoreTeamsAndMatchesAsync(_apiClient, _dataService, currentSeason.Year.Value, leagues);
                }
            }

            // Fetch players
            Console.WriteLine("→ Fetching Players...");
            await FetchAndStorePlayersAsync(_apiClient, _dataService);

            Console.WriteLine("\n✓ Auto-fetch complete!");
        }

        static async Task ClearAllDataAsync()
        {
            Console.Clear();
            Console.WriteLine("╔════════════════════════════════════════════╗");
            Console.WriteLine("║         Clear All Data                     ║");
            Console.WriteLine("╚════════════════════════════════════════════╝\n");

            Console.WriteLine("⚠ This will delete ALL data from the database.");
            Console.Write("Are you sure? (yes/no): ");
            string? confirm = Console.ReadLine()?.ToLower();

            if (confirm == "yes")
            {
                await _dataService.ClearAllDataAsync();
                Console.WriteLine("✓ All data cleared successfully.\n");
            }
            else
            {
                Console.WriteLine("✗ Clear operation cancelled.\n");
            }
        }

        static void WaitForKeyPress()
        {
            Console.WriteLine("\nPress any key to continue...");
            Console.ReadKey();
        }
    }
}
